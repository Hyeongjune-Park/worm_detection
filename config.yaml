# config.yaml — Human-in-the-Loop Multi-Sensor Tracking Pipeline

project:
  output_dir: "outputs"
  save_overlay_video: true
  save_csv: true
  save_events: true

input:
  path: "video"

video:
  fps_fallback: 30
  overlay_fourcc: "mp4v"

preprocess:
  use_gray: true
  denoise:
    enabled: true
    ksize: 3
  clahe:
    enabled: false
    clipLimit: 2.0
    tileGridSize: [8, 8]

# Arena (영역 밖 무시)
arena:
  enabled: false
  manual_rect:
    enabled: false
    x0: 0
    y0: 0
    x1: 0
    y1: 0

# ROI (트랙별 관심 영역)
roi:
  base_size: 384
  min_size: 256
  max_size: 640

# 센서 설정
sensors:
  sam2:
    enabled: true
    model_type: "sam2.1/sam2.1_hiera_t"
    checkpoint_path: "sam2/checkpoints/sam2.1_hiera_tiny.pt"
    update_every_n: 1
    measurement_noise_r: 10.0
  template:
    enabled: true
    patch_size: 64
    use_edge: true
    update_quality_thresh: 0.85
    measurement_noise_r: 25.0
  klt:
    enabled: true
    max_corners: 100
    quality_level: 0.01
    min_distance: 7
    win_size: 15
    max_level: 3
    min_valid_points: 10
    measurement_noise_r: 25.0

# QA / Fusion (교차검증) — ROI diagonal 대비 비율 기반
qa:
  dist_pred_ratio: 0.12        # SAM2↔predict 거리 / ROI_diag
  dist_tpl_ratio: 0.12         # SAM2↔template 거리 / ROI_diag
  dist_klt_ratio: 0.12         # SAM2↔KLT 거리 / ROI_diag
  border_touch_thresh: 0.3
  uncertain_to_occluded_frames: 5
  occluded_to_reseed_frames: 30

# 트래킹 전반
tracking:
  max_tracks: 10
  kalman:
    process_noise_q: 2.0
    default_measurement_noise_r: 25.0
  state_machine:
    border_exit_margin_px: 5
    immobile_window: 60
    immobile_speed_px_per_s: 1.0
    merge_distance_px: 30.0

# Head 추정 (보조)
head:
  enabled: true
  min_movement_px: 2.0
  smoothing_window: 5

# ======================================================================
# Feature Toggles (기능 토글)
# 2026-01-27 base 이후 추가된 개선 기능을 개별 ON/OFF.
# OFF = base 동작 복원. A/B 테스트를 위해 조합 변경 가능.
# ======================================================================
toggles:
  # --- Fusion (qa/fusion.py) ---
  active_reacquire_split: true       # F1: ACTIVE(엄격) vs REACQUIRE(관대) 모드 분리
  soft_pred_penalty: false           # F2: pred 거리 소프트 페널티 (위험, 기본 OFF)
  strict_consensus: true             # F3: 엄격한 consensus — None=불합의 (버그수정)
  area_continuity_penalty: false     # F4: 면적 연속성 quality 감점 (기본 OFF)
  reacquire_active_recovery: true    # F5: REACQUIRE→ACTIVE 복귀 경로

  # --- Pipeline / ROI (pipeline/runner.py) ---
  speed_roi_expansion: false         # P1: 속도 기반 ROI 확장 (위험, 기본 OFF)
  state_roi_expansion: false         # P2: UNCERTAIN/OCCLUDED ROI 1.25x (기본 OFF)
  expansion_cooldown: false          # P3: ROI 확장 쿨다운 5프레임 (기본 OFF)
  sam2_bbox_sync: false              # P4: SAM2 bbox 독립 동기화 (위험, 기본 OFF)
  reacquire_box_expansion: false     # P5: REACQUIRE 시 box prompt 확장 (기본 OFF)
  adaptive_prompt_box: true          # P6: SAM2 box prompt EMA 적응 (신규 baseline)

  # --- Sensor ---
  composite_mask_selection: true     # S1: SAM2 복합 점수 마스크 선택
  template_update_gating: true       # S2: SAM2 quality >= 0.7일 때만 TPL 갱신
  klt_divergence_reinit: true        # S3: KLT-SAM2 발산 시 KLT 재초기화
  sam2_mask_caching: true            # S4: SAM2 QA 통과 시 결과 캐싱

  # --- Shape Quality ---
  shape_quality_gate: true            # SH1: ShapeStats 기반 bbox HOLD / cache 차단 / quality 감점

  # --- Mask Cleanup ---
  mask_cleanup: false                  # MC1: 번짐 감지 시 CCF+Expected Region 마스크 정리

  # --- Kalman ---
  velocity_decay_on_predict: true    # K1: predict-only 시 velocity 감쇠 (0.5x)
  innovation_gating: false           # K2: Mahalanobis outlier gating (기본 OFF)

  # --- State Machine ---
  occluded_to_uncertain_recovery: false  # SM1: OCCLUDED→UNCERTAIN 복귀 허용 (기본 OFF)

# 모션 검출 (보조/복구 힌트용, 주 센서 아님)
detection:
  bg:
    alpha: 0.02
    freeze_fg_update: true
  fg:
    threshold: 25
    morph_open: 3
    morph_close: 5
