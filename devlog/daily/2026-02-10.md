# 2026-02-10 Daily Devlog

## TODO
- [x] Step 0: Dynamic R 롤백 (_quality_r_scale 제거)
- [x] Step 1: Innovation gating (K2) 구현 (kalman.py + config_toggles + runner.py)
- [x] Step 2: baseline 테스트 (롤백 후, K2=OFF)
- [x] Step 3: K2=ON 테스트 + MC1+P2 조합 테스트
- [x] Step 4: 결과 비교 및 기록
- [ ] 육안 검증 (overlay 비교)

## 작업 기록

### Step 0: Dynamic R 롤백
- `qa/fusion.py`에서 `_quality_r_scale()` 함수 및 3곳 호출 제거
- 02-09에 추가한 quality 기반 R 스케일링이 velocity drift 원인으로 확인됨
- 롤백 후 baseline ACTIVE=383 복원 (02-07과 동일)

### Step 1: Innovation Gating (K2)
- `tracking/kalman.py`: `innovation_check()` 메서드 추가 (Mahalanobis distance)
- `config_toggles.py`: `innovation_gating` 토글 추가 (K2, 기본 OFF)
- `pipeline/runner.py`: KF update 전 innovation gate 체크, reject 시 predict-only + velocity decay
- ACTIVE 상태에서만 적용 (REACQUIRE는 큰 이동이 정상이므로 제외)

### Step 2-3: K2 threshold 튜닝 + 조합 테스트

#### Mahalanobis 분포 분석 (maha50 기준)
- n=397, median=0.03, p90=5.67, p95=11.59, p99=52.0, max=74.0
- threshold=9.21(99%): 7.3% 거부 → 너무 strict (ACTIVE=305, RESEED=2)
- threshold=50: 1.0% 거부 → 극단 outlier만 (ACTIVE=425, RESEED=1)

#### 테스트 결과 비교

| Config | ACTIVE | OCCLUDED | UNCERTAIN | RESEED | Changes |
|--------|--------|----------|-----------|--------|---------|
| baseline | 383 | 176 | 14 | 1 | 72 |
| K2 maha9.21 | 305 | 112 | 11 | 2 | 37 |
| **K2 maha50** | **425** | 140 | 8 | **1** | 68 |
| K2+P2 | 491 | 148 | 22 | 2 | 86 |
| MC1+P2 | 569 | 99 | 26 | 1 | 76 |
| K2+MC1+P2 | 569 | 99 | 26 | 1 | 76 |

#### 분석
1. **K2 단독 (maha50)**: ACTIVE +42 (383→425), RESEED=1 유지 — 유의미한 독립 개선
2. **K2+MC1+P2 = MC1+P2**: 완전 동일 — MC1+P2가 이미 K2가 잡는 outlier를 처리
3. **K2+P2**: RESEED=2 — K2가 ACTIVE→UNCERTAIN 전환 직후 재획득을 방해
4. **threshold 9.21은 너무 strict**: 정상적 10-20px 이동도 거부됨 (P matrix가 작을 때)

#### 결론
- **최적 config는 여전히 MC1+P2** (ACTIVE=569, RESEED=1)
- K2는 독립적으로 +42 ACTIVE 효과가 있으나, MC1+P2와 병용 시 추가 효과 없음
- K2는 안전장치로 유지하되 기본 OFF (MC1+P2 없이 사용 시에만 가치 있음)

