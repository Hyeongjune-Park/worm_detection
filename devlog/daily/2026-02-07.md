# 2026-02-07 작업 기록

## TODO

- [x] SH1_OFF의 overlay 영상 확인 (실제 추적 품질 검증)
- [x] P2, F3 overlay 영상 확인 → **실제로 가장 좋은 추적**
- [ ] SAM2 잎맥 번짐 문제 대응 방안 설계 및 구현
- [ ] K1, SM1 단일 토글 테스트 완료
- [ ] P2 + F3 조합 테스트
- [ ] 최적 조합 확정 후 config.yaml 기본값 변경

---

## 어제까지 진행 상황 요약

### 구현 완료
1. **Skeleton 기반 shape analysis** — tube_fit, width_cv, worm_ratio, branch_points
2. **SH1 shape_quality_gate** — fusion/runner에서 shape_score 기반 거부/페널티
3. **Baseline 기반 이상 감지** — 첫 프레임 대비 상대값으로 플래그
4. **전환점 스냅샷** — 5프레임 지속 필터 + before/event/after 3장
5. **플래그 타입 변화 감지** — frozenset 기반 problem_start/end/change

### A/B 테스트 결과 (단일 토글, 15/17 완료)

**Baseline**: ACTIVE=383, OCCLUDED=176, RESEED=1, SAM2=405

| Toggle | ACTIVE | OCCLUDED | RESEED | 판정 |
|--------|--------|----------|--------|------|
| **SH1_shape_gate_OFF** | **714 (+331)** | **27** | **0** | Best |
| P2_state_roi_ON | 526 (+143) | 96 | 1 | Good |
| F3_strict_OFF | 565 (+182) | 72 | 1 | 위험 |
| F2_soft_pred_ON | 489 (+106) | 141 | 1 | OK |
| P4_bbox_sync_ON | 452 (+69) | 295 | 0 | OK |
| S3_klt_reinit_OFF | 424 (+41) | 136 | 1 | 미미 |
| P1_speed_roi_ON | 383 (±0) | 176 | 1 | 무효과 |
| S2_tpl_gate_OFF | 383 (±0) | 176 | 1 | 무효과 |
| F1_split_OFF | 329 (-54) | 114 | 2 | 해로움 |
| F4_area_penalty_ON | 318 (-65) | 126 | 2 | 해로움 |
| S4_cache_OFF | 274 (-109) | 77 | 2 | 해로움 |
| S1_composite_OFF | 283 (-100) | 68 | 2 | 해로움 |
| F5_recovery_OFF | 265 (-118) | 56 | 2 | 해로움 |

**미완료**: K1_vel_decay_OFF, SM1_occ_recovery_ON

---

## 오늘 작업 내용

### 1. 육안 검증 결과 — 수치 지표 vs 실제 품질 괴리

**중요 발견: ACTIVE 수치만으로 추적 품질을 판단할 수 없음**

#### SH1_shape_gate_OFF (수치 1위 → 실제 불량)
- 초록/파란 벌레를 **초기에 놓치고** 빈 배경(풀잎) 영역을 지속 추적
- shape gate가 없어서 배경 마스크도 거부되지 않음 → ACTIVE 높지만 의미없는 추적
- **결론: SH1_OFF 단독 사용 불가**. shape gate는 필요하되, 임계값 조정 필요

#### P2_state_roi_ON & F3_strict_OFF (수치 2-3위 → 실제 최고)
지금까지 테스트 중 **가장 좋은 추적 양상**:

**초록 벌레 (Track 1)**:
1. 이전 테스트에서 첫 큰 움직임 시 항상 놓침 → **이번엔 SAM2가 정확히 따라감** (첫 돌파)
2. 제자리 맴돌 때 어두운 잎맥 영역으로 마스킹 번짐 발생
3. 벌레가 아래로 이동 → ROI 밖으로 이탈 (시스템은 잎맥 추적 중이라 인지 못함)
4. 벌레가 ROI에 재진입 → 처음엔 관성적으로 잎 추적 (벌레를 피해 마스킹)
5. 벌레가 마스킹 영역 주위를 지속 맴돌자 → **자연 재추적 성공**
6. 다시 제자리 맴돌 → 잎맥으로 재번짐

**파란 벌레 (Track 2)**:
1. **이전에 전혀 추적 안 되던 것이 이번엔 초반 움직임 추적 성공** (돌파)
2. 선명한 잎맥 줄기 근처에서 마스킹 노이즈 → 잎맥+벌레 둘러싼 영역으로 번짐
3. NEEDS_RESEED 상태로 전락

**빨간 벌레 (Track 3)**:
- 대부분 잘 추적됨. 머리 1/4이 마스크에서 빠지고 몸통 3/4만 추적
- 잎으로 번지는 경향 없음

### 2. 핵심 문제: SAM2 잎맥 번짐 (Vein Bleeding)

#### 패턴 분석
```
정상 추적 → 제자리 맴돌기 → 잎맥으로 번짐 → 벌레가 ROI 이탈 → 추적 실패
```

#### 번짐 발생 조건
1. **벌레가 정지/느린 움직임** (제자리 맴돌기)
2. **근처에 어둡고 선명한 잎맥 존재** (높은 대비 경계)
3. SAM2가 잎맥 텍스처를 벌레 경계와 혼동

#### 번짐의 특징
- 벌레보다 어두운 잎맥 + 선명한 경계 → SAM2에게 "강한 함정"
- 번짐 시 shape가 elongated → irregular blob으로 변화
- 기존 shape analysis로 **번짐 감지는 가능** (tube_fit 하락, width_cv 증가)
- 문제는 **감지 후 어떻게 대응할 것인가**

### 3. 번짐 대응 방안 분석

#### 현재 가능한 대응 (shape gate 기반)
- **감지**: shape_score < threshold → 번짐 발생 감지 가능
- **현재 대응**: predict-only fallback (SH1) → 위치 드리프트 축적 문제

#### 필요한 새로운 대응
감지는 되지만, 번짐을 **막거나 복구**하는 메커니즘이 없음:

1. **SAM2 prompt 리셋**: 번짐 감지 시 마지막 좋은 mask로 prompt 재설정
2. **ROI 강제 재센터링**: 번짐 시 TPL/KLT 위치로 ROI 이동
3. **mask morphology 후처리**: SAM2 출력에서 벌레 형태만 추출
4. **negative prompt**: 잎맥 영역을 negative point로 지정

