# 2026-01-31 작업 기록

## 발견된 문제

### SAM2 마스크는 정확하지만 bbox가 업데이트되지 않는 현상

**증상 (스크린샷 분석)**:

1. **정상 추적 중**: SAM2 마스크가 벌레를 정확히 감싸고, bbox도 벌레 위치에 있음. 모든 센서 마커들이 벌레 위에 위치
   - 파란 네모 (Kalman 예측)
   - 녹색 원 (SAM2 중심)
   - 빨간 다이아몬드 (Template)

2. **벌레 큰 움직임 발생**: SAM2 마스크는 여전히 벌레를 **정확히** 따라감. 하지만:
   - bbox는 이전 위치에 머무름
   - 상태가 OCCLUDED로 전환
   - Kalman 예측(파란 네모)이 이동 방향을 가장 잘 추적 (벌레보다 약간 앞서 예측)

3. **문제 심화**: SAM2가 정확한 위치를 알고 있음에도:
   - bbox가 SAM2 위치로 갱신되지 않음
   - 이전 위치에서 배경 추적 시작
   - ROI가 확장되며 넓은 배경 영역을 벌레로 인식
   - 결국 모든 센서가 잘못된 영역을 추적

**핵심 문제**: SAM2의 마스크 출력은 정확하지만, QA fusion에서 이를 거부하여 Kalman 업데이트가 이루어지지 않음

---

## 문제 분석

### 오버레이 마커 설명
| 마커 | 색상 | 의미 |
|------|------|------|
| 네모 (□) | 파란색 | Kalman 예측 위치 |
| 원 (○) | 녹색 | SAM2 centroid |
| 다이아몬드 (◇) | 빨간색 | Template 매칭 위치 |
| X | 흰색 | 최종 융합 결과 |

### 확인된 원인: QA의 `pred_ok` 하드 게이트

**코드 위치**: `qa/fusion.py:111`

```python
pred_ok = (d_pred <= dist_pred_th)  # SAM2 center ↔ Kalman pred 거리
```

**임계값 계산**:
- ROI base_size = 384px
- ROI diagonal = 384 × √2 ≈ 543px
- dist_pred_ratio = 0.12 (config.yaml)
- **dist_pred_th ≈ 65px**

**문제**:
- 벌레가 65px 이상 움직이면 SAM2가 정확해도 거부됨
- Kalman은 급격한 움직임 변화를 예측 못함 (방향 전환, 가속)
- 결과: 올바른 SAM2 → QA 거부 → Kalman 업데이트 안됨 → 악순환

**핵심**: QA가 Kalman 예측을 "신뢰할 수 있는 기준점"으로 가정하지만, 이 가정이 빠른 움직임에서 틀림

---

## 오늘의 작업

| 순서 | 작업 | 상태 | 설명 |
|------|------|------|------|
| 1 | QA fusion 거부 원인 분석 | 진행중 | SAM2가 거부되는 조건 확인 |
| 2 | ... | 대기 | ... |

---

## 커밋 이력

| 해시 | 설명 |
|------|------|
| ... | ... |
