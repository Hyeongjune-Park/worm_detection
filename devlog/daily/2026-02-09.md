# 2026-02-09 작업 기록

## TODO

### GPT 리뷰 기반 안전성 개선 (우선)
- [x] Dynamic measurement_r: quality 기반 Kalman R 스케일링 → **확정 (ACTIVE 383→457)**
- [x] MC1 self-verification: cleanup 후 shape_score 미개선 시 revert → **제거 (너무 엄격)**
- [x] MC1 aspect_ratio 버그: `max(ar,1)` → `max(ar, 1/ar)` → **수정 완료**
- [x] 테스트 실행 및 결과 비교 → **MC1+dynamicR 상호작용 문제 발견**

### 조합 최적화 (이후)
- [ ] MC1 overlay 육안 검증 (MC1 단독, MC1+P2) → 사용자 확인 대기
- [ ] K1, SM1 단일 토글 테스트 (2/17 미완료)
- [ ] P2 + F3 조합 테스트
- [ ] MC1 + P2 + 추가 조합 탐색
- [ ] 최적 조합 확정 후 config.yaml 기본값 변경

### Phase 2 (안정화 후)
- [ ] mask_input 도입 검토
- [ ] prompt 개선 (box shrink, multi-positive)

---

## 이전 작업 요약

### MC1 Mask Cleanup Pipeline (2026-02-07 구현)
- `qa/mask_cleanup.py` — CCF + 조건부 Erosion + Expected Region AND
- shape_score < 0.8 감지 시 마스크 정리 후 ShapeStats 재분석
- 토글: `mask_cleanup` (MC1), 기본 OFF

### 테스트 결과 (수치)
| 설정 | ACTIVE | OCCLUDED | UNCERTAIN | RESEED |
|------|--------|----------|-----------|--------|
| Baseline | 383 | 176 | 14 | 1 |
| MC1 단독 | 473 (+90) | 51 (-125) | 21 | 1 |
| P2 단독 | 526 (+143) | 96 | 3 | 1 |
| MC1 + P2 | **569 (+186)** | 99 | 26 | 1 |

**overlay 육안 검증 미완료** — 수치만으로 판단 불가 (SH1_OFF 교훈)

---

## 오늘 작업 내용

### 1. GPT 리뷰 기반 3가지 수정

GPT 코드 리뷰 의견을 반영하여 다음 3가지 수정 적용:

#### 1-1. Dynamic measurement_r (fusion.py)
quality 기반 Kalman measurement noise 스케일링 추가:
- `q >= 0.8` → R 그대로 (고신뢰)
- `0.6 <= q < 0.8` → R × 1.0~3.0 (저신뢰, 드리프트 억제)
- `q < 0.6` → R × 5.0 (거의 무시)

ACTIVE/REACQUIRE/BASE 3개 경로 모두에 적용.

#### 1-2. MC1 self-verification (runner.py)
cleanup 후 shape_score가 개선되지 않으면 원본 mask 유지.
→ **결과: 너무 엄격해서 유용한 cleanup도 revert → 악화. 제거함.**

#### 1-3. MC1 aspect_ratio 버그 수정 (mask_cleanup.py)
`max(ar, 1.0)` → `max(ar, 1.0 / max(ar, 0.01))` — 세로형 벌레(ar < 1) 정보 보존.

### 2. 테스트 결과 — dynamic R과 MC1 상호작용 문제 발견

| 설정 | ACTIVE | OCCLUDED | UNCERTAIN | RESEED | 비고 |
|------|--------|----------|-----------|--------|------|
| **이전 baseline** (dynamic R 없음) | 383 | 176 | 14 | 1 | 기존 기준 |
| **새 baseline** (dynamic R만) | **457 (+74)** | 102 | 14 | 1 | dynamic R 효과 |
| MC1 + dynamic R | 384 | 124 | 27 | **2** | **regression** |
| MC1 + P2 + dynamic R | 371 | 126 | 9 | **2** | **regression** |

#### 원인 분석: MC1과 dynamic R의 역설적 상호작용

```
Dynamic R 단독:
  shape_score 낮음 → quality 낮음 → R 높음 → KF가 prediction 신뢰 → 드리프트 억제 ✓

MC1 + Dynamic R:
  shape_score 낮음 → MC1 cleanup → shape_score 올라감 → quality 올라감
  → R 낮아짐 → KF가 (불완전한) cleanup measurement 신뢰 → 드리프트 발생 ✗
```

MC1이 shape_score를 인위적으로 올려서 dynamic R의 안전장치를 우회하는 구조.
추가로 cleanup 후 centroid 이동이 TPL/KLT consensus를 깨뜨림 → RESEED 증가.

#### 결론 (수치 기반)
- **Dynamic R: 수치상 개선** — 단독으로 ACTIVE 383→457
- **MC1: 보류** — dynamic R과 조합 시 regression

### 3. 육안 검증 — dynamic R이 추적을 악화시킴

overlay 영상 비교 결과 (MC1+P2 조합, 가장 의미 있는 비교):

#### MC1+P2 원본 (dynamic R 없음, 2026-02-07) — **가장 좋은 추적**
- 파란 벌레: 초반~중반 거의 완벽 추적, 후반 정지 후 다른 벌레 방향으로 튐
- 초록 벌레: 첫 큰 움직임 추적 성공, 정지 시 잎으로 번짐, 재추적 성공도 있음
- SAM2 box가 작은 형태로 제어 → 배경 번짐 차단 효과

#### MC1+P2 v2 (dynamic R + self-verification) — **악화**
- 파란 벌레: 정지 시 문제 시작
  - 인접 벌레가 box 영역 진입 시 두 벌레 동시 마스킹
  - **Bbox 불일치**: SAM2 마스크는 벌레를 정확히 감싸는데, 박스는 가로 길쭉하게 벌레 일부만 포함 → OCCLUDED
  - 프레임 단위 깜빡임: 정확한 마스크 ↔ 박스 모양 마스크 반복
  - 초록 추적이 배경으로 튀자 파란 추적도 같이 끌려감
- 초록 벌레: 첫 움직임 후 배경으로 튐, 정지 시 벌레는 세로인데 박스는 가로 → UNCERTAIN/OCCLUDED

#### MC1+P2 v3 (dynamic R, self-verification 제거) — **최악**
- 파란 벌레: 마스크 정확한데 박스 불일치(가로 길쭉) → OCCLUDED → **RESEED로 사망**
- 초록 벌레: 첫 움직임에서 바로 놓침, **방향성+속도감 있게 배경으로 드리프트** → 접시 밖까지 이동 → RESEED

#### MC1 단독 (3버전 모두) — **일관되게 나쁨**
- P2 없으면 ROI가 좁아 SAM2가 큰 움직임을 놓침
- 파란 벌레 즉시 실패, 초록 벌레 첫 움직임 후 배경으로 전환

### 4. 핵심 발견

#### 발견 1: Dynamic R이 속도 드리프트를 악화시킴
dynamic R → KF가 measurement 덜 신뢰 → **prediction(=velocity) 더 신뢰**
→ velocity가 잘못된 방향이면 그 방향으로 가속 드리프트 발생
→ K1 velocity_decay는 predict-only에서만 작동, dynamic R은 update를 하므로 velocity decay 안 됨

#### 발견 2: Bbox 불일치 문제 (seed_bbox 고정 크기)
SAM2 prompt box = Kalman 예측 center + **seed bbox 고정 크기/비율**
벌레가 회전하거나 방향이 바뀌면 seed bbox와 실제 형태가 불일치
→ SAM2가 box 밖의 벌레 부분을 놓침 → 불완전 마스크 → OCCLUDED

#### 발견 3: MC1+P2(원본)이 여전히 최고
dynamic R을 추가하기 전 MC1+P2가 가장 좋은 추적. Dynamic R은 수치(ACTIVE)만 올리고 실제 추적은 악화.
**SH1_OFF 교훈 재현**: 수치 개선 ≠ 실제 추적 개선

### 5. 결론 및 다음 단계

#### Dynamic R: 채택 보류 (수치만 좋고 실제 악화)
- 속도 드리프트 문제 해결 전까지 적용 불가
- 해결 방안: dynamic R 적용 시 velocity_decay도 함께 적용하거나, R 증가폭 제한

#### MC1+P2: 현재 최적 조합 확정
- 2026-02-07 버전 (dynamic R 없음)이 가장 좋은 추적

#### Bbox 불일치: 별도 이슈로 추적 필요
- seed_bbox 고정 크기 → 벌레 방향 변화에 취약
- SAM2 마스크 bbox로 prompt box 동적 갱신 검토 (P4 토글과 관련)
