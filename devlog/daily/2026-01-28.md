# 2026-01-28 작업 기록

## SAM2.1 로딩 수정

- `sensors/sam2_sensor.py`: Hydra `initialize_config_dir()` 추가하여 SAM2.1 config 경로 등록
- `config.yaml`: `model_type`을 `"sam2.1/sam2.1_hiera_t"`로 변경 (hydra config 하위 디렉토리 구조 반영)
- 의존성 추가: `iopath` (SAM2 modeling 의존)

## 트래킹 드리프트 버그 수정 (6건)

첫 테스트 실행 결과 분석: 벌레 중심점과 bbox가 불일치하고, 양쪽 트랙이 arena 끝으로 일직선 드리프트하는 현상 발견.

### Fix 1: Arena 기본값 안전화
- **파일**: `config.yaml`
- **문제**: `arena.enabled: true` + 좌표 `(0,0,0,0)` → `--arena` 미사용 시 ROI가 0크기로 수렴
- **수정**: 기본값을 `enabled: false`로 변경. `--arena` 인자 주입 시에만 활성화

### Fix 2: Fusion Case A에 KLT 교차검증 추가
- **파일**: `qa/fusion.py`
- **문제**: Case A(SAM2 신뢰) 조건이 `pred_ok AND tpl_ok AND border_ok`만 검사. KLT가 다른 곳을 가리켜도 SAM2가 통과 가능
- **수정**: `klt_ok = (c_klt is None) or (d_klt <= dist_klt_th)` 조건 추가. 3개 센서 교차검증 완성

### Fix 3: Template 업데이트 조건 강화 (drift-lock 방지)
- **파일**: `pipeline/runner.py`
- **문제**: `quality_score > 0`이면 무조건 template 업데이트 시도 → TPL 센서가 드리프트한 상태에서 자기 결과로 다시 업데이트하면 오염 고착
- **수정**: `sensor_used == "SAM2" AND quality_score >= 0.7`일 때만 template 업데이트. SAM2 교차검증을 통과한 신뢰 좌표로만 갱신

### Fix 4: bbox를 center 기반으로 갱신 (SAM2 미사용 시)
- **파일**: `pipeline/runner.py`
- **문제**: bbox가 SAM2 성공 시에만 갱신. SAM2 실패 후 center는 TPL/KLT/PRED로 이동하는데 bbox는 옛날 위치에 고정 → 오버레이에서 박스와 점 위치 불일치
- **수정**: `do_kalman_update=True`일 때 기존 bbox 크기를 유지하면서 center에 맞춰 bbox 이동

### Fix 5: KLT Forward-Backward error 임계값 완화
- **파일**: `sensors/klt_sensor.py`
- **문제**: FB error < 1.0px 고정은 매우 엄격. 유효 점이 쉽게 부족해져 reinit → None 반환 반복 → fusion에서 KLT 공백 빈번
- **수정**: 기본값을 2.0px로 완화 (`fb_error_thresh` 설정 추가). KLT가 더 많은 프레임에서 측정값을 제공

### Fix 6: Kalman predict-only 속도 감쇠 (무한 드리프트 방지)
- **파일**: `tracking/kalman.py`, `pipeline/runner.py`
- **문제**: Case C(PRED only)에서 `do_kalman_update=False` → Kalman이 마지막 속도(vx,vy)로 매 프레임 이동 → arena 끝까지 일직선 드리프트 (id=2, id=3 증상의 직접 원인)
- **수정**: `KalmanFilter2D.decay_velocity(factor=0.5)` 메서드 추가. predict-only 시 매 프레임 속도를 50% 감쇠하여 빠르게 정지

## 알고리즘 변경 요약

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| Fusion Case A 검증 | pred + tpl + border (2센서) | pred + tpl + klt + border (3센서) |
| Template 업데이트 | quality > 0 (거의 항상) | SAM2 융합 성공 + quality >= 0.7 |
| KLT FB error | 1.0px 고정 | 2.0px (설정 가능) |
| Predict-only 동작 | 속도 유지 (드리프트) | 속도 50% 감쇠 (수렴) |
| bbox 갱신 | SAM2 성공 시만 | 모든 센서 업데이트 시 center 기반 |

## 레거시 파일 삭제

사용하지 않는 모듈 삭제:
- `detection/` 폴더 전체 (background_model.py, motion_detector.py)
- `segmentation/` 폴더 전체 (base.py, sam2_adapter.py)
- `tracking/multi_tracker.py`, `tracking/association.py`

현재 파이프라인에서 import 없음 확인 후 삭제.

## 센서 융합 근본 원인 진단 및 수정 (3건)

두 번째 테스트 실행 결과: id=2는 정상 추적, id=1과 id=3이 30프레임 이내에 NEEDS_RESEED로 전이.

### 디버그 로깅 진단

`qa/fusion.py`와 `sensors/sam2_sensor.py`에 디버그 출력 추가하여 정확한 실패 원인 파악:

- **border_touch = 0.000** → ChatGPT가 제시한 border_touch 가설은 원인 아님
- **SAM2 예외 없음** → SAM2 자체는 정상 동작
- **진짜 원인: KLT가 배경 특징점을 추적** → d_klt = 74~80px (임계값 65px 초과) → 3센서 AND 게이트에서 SAM2 거부
- **TPL도 TM_CCORR_NORMED 사용으로 잎사귀 텍스처에 오매칭** → d_tpl도 임계값 초과

결론: SAM2는 정확했으나, KLT와 TPL이 모두 벗어나면서 엄격한 3센서 AND 조건이 SAM2를 차단.

### Fix 7: Fusion Case A를 2-of-3 투표로 변경
- **파일**: `qa/fusion.py`
- **문제**: `pred_ok AND tpl_ok AND klt_ok AND border_ok` — 3센서 전부 동의해야 SAM2 채택. KLT 하나만 벗어나도 차단
- **수정**: `pred_ok AND (tpl_ok OR klt_ok) AND border_ok` — SAM2+pred 필수, tpl/klt 중 하나만 동의하면 통과 (둘 다 None이면 SAM2+pred만으로 통과)

### Fix 8: Template 매칭 방식 변경
- **파일**: `sensors/template_sensor.py`
- **문제**: `TM_CCORR_NORMED`는 mean-subtraction 없이 상관 계산 → 균일한 잎사귀 텍스처에서 false match 발생
- **수정**: `TM_CCOEFF_NORMED`로 변경 (mean-subtracted NCC). 텍스처가 아닌 실제 패턴 유사도 기반 매칭

### Fix 9: KLT 자동 재초기화
- **파일**: `pipeline/runner.py`
- **문제**: KLT가 배경 특징점을 추적하면 fusion에서 계속 거부당하지만, KLT 자체는 reinit 트리거 없이 오염된 상태 유지
- **수정**: SAM2 융합 성공 시 KLT center와 SAM2 center 거리가 ROI 크기의 15% 초과하면 KLT를 현재 위치에서 자동 재초기화

### 결과

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| Fusion Case A 검증 | 3센서 AND (전부 동의) | 2-of-3 투표 (pred 필수 + tpl/klt 중 하나) |
| Template 매칭 | TM_CCORR_NORMED (false match) | TM_CCOEFF_NORMED (mean-subtracted) |
| KLT 재초기화 | valid points 부족 시만 | SAM2 불일치 15% 초과 시 자동 reinit |

**최종 실행 결과**: 3개 트랙 모두 255프레임 전체에서 ACTIVE [SAM2] q=1.00 유지, 상태 전이 0건.

## 기타

- `io_utils/overlay.py`: head arrow 표시 비활성화 (추후 별도 추가)
- `Readme.md`: 파일 구조에서 레거시 항목 제거, QA Fusion 설명 업데이트
