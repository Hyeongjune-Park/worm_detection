# 2026-02-04 작업 기록

## 오늘의 작업

| 순서 | 작업 | 상태 | 설명 |
|------|------|------|------|
| 1 | Feature Toggle 시스템 설계 | 완료 | GPT 제안 + 코드 분석 기반 16개 토글 식별 |
| 2 | config_toggles.py 생성 | 완료 | FeatureToggles frozen dataclass, from_config/to_dict/summary/의존성경고 |
| 3 | config.yaml toggles 섹션 추가 | 완료 | 보수적 baseline: 안정=ON, 위험=OFF |
| 4 | qa/fusion.py 토글 적용 | 완료 | F1~F5 (mode split, soft penalty, consensus, area, recovery) |
| 5 | pipeline/runner.py 토글 적용 | 완료 | P1~P5, S2~S4, K1 (ROI, bbox, sensor, kalman) |
| 6 | sensors/sam2_sensor.py 토글 적용 | 완료 | S1 (composite mask selection) |
| 7 | tracking/state_machine.py 토글 적용 | 완료 | SM1 (OCCLUDED→UNCERTAIN recovery) |
| 8 | io_utils/debug_logger.py 토글 기록 | 완료 | record_toggles + run_summary.json에 포함 |
| 9 | import 검증 | 완료 | 모든 모듈 정상 import 확인 |
| 10 | GPT 코드 점검 리뷰 | 완료 | GPT→Claude→GPT 3단 논의, 5개 이슈 분석 |
| 11 | P0: area_check_available 순환 의존 수정 | 완료 | fusion.py 하드게이트→소프트 페널티, runner.py bbox sync 동일 수정 |

---

## 구현된 토글 목록 (16개)

### Fusion (qa/fusion.py)
| ID | 이름 | 기본값 | 설명 |
|----|------|--------|------|
| F1 | `active_reacquire_split` | ON | ACTIVE(엄격) vs REACQUIRE(관대) 모드 분리 |
| F2 | `soft_pred_penalty` | OFF | pred 거리 소프트 페널티 (하드게이트 대체) |
| F3 | `strict_consensus` | ON | 엄격한 consensus (None=불합의, 버그수정) |
| F4 | `area_continuity_penalty` | OFF | 면적 연속성 quality 감점 |
| F5 | `reacquire_active_recovery` | ON | REACQUIRE→ACTIVE 복귀 경로 |

### Pipeline / ROI (pipeline/runner.py)
| ID | 이름 | 기본값 | 설명 |
|----|------|--------|------|
| P1 | `speed_roi_expansion` | OFF | 속도 기반 ROI 1.5x~2.0x 확장 |
| P2 | `state_roi_expansion` | OFF | UNCERTAIN/OCCLUDED ROI 1.25x 확장 |
| P3 | `expansion_cooldown` | OFF | ROI 확장 쿨다운 5프레임 |
| P4 | `sam2_bbox_sync` | OFF | SAM2 bbox 독립 동기화 |
| P5 | `reacquire_box_expansion` | OFF | REACQUIRE 시 box prompt 확장 |

### Sensor
| ID | 이름 | 기본값 | 설명 |
|----|------|--------|------|
| S1 | `composite_mask_selection` | ON | SAM2 복합 점수 마스크 선택 |
| S2 | `template_update_gating` | ON | quality >= 0.7일 때만 TPL 갱신 |
| S3 | `klt_divergence_reinit` | ON | KLT-SAM2 발산 시 재초기화 |
| S4 | `sam2_mask_caching` | ON | SAM2 QA 통과 시 결과 캐싱 |

### Kalman / State Machine
| ID | 이름 | 기본값 | 설명 |
|----|------|--------|------|
| K1 | `velocity_decay_on_predict` | ON | predict-only 속도 감쇠 0.5x |
| SM1 | `occluded_to_uncertain_recovery` | OFF | OCCLUDED→UNCERTAIN 복귀 허용 |

---

## 의존성 맵

```
sam2_mask_caching → area_continuity_penalty (prev_area 필요)
                  → composite_mask_selection (prev_area scoring)
active_reacquire_split → reacquire_active_recovery (split 내부)
speed_roi_expansion ─┐
state_roi_expansion ─┼→ expansion_cooldown (확장 없으면 무의미)
                     └→ reacquire_box_expansion (expansion 값)
```

---

## 수정된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `config_toggles.py` | 신규 생성 — FeatureToggles dataclass |
| `config.yaml` | toggles 섹션 추가 (16개 토글) |
| `qa/fusion.py` | fuse() 리팩토링 — F1~F5 토글, 헬퍼 함수 분리 |
| `pipeline/runner.py` | 토글 초기화 + P1~P5, S2~S4, K1 적용 |
| `sensors/sam2_sensor.py` | S1 composite mask selection 토글 |
| `tracking/state_machine.py` | SM1 OCCLUDED recovery 토글 |
| `io_utils/debug_logger.py` | record_toggles + run_summary에 포함 |

---

## 커밋 이력

| 해시 | 설명 |
|------|------|
| 790867c | Add debug logger, shape analyzer, and devlog for 2026-01-31 |
| 2557918 | Add feature toggle system for A/B testing (16 toggles) |

---

## P0 버그 수정: area_check_available 순환 의존

### 문제
- ACTIVE 모드 SAM2 채택 조건에 `area_check_available`이 하드게이트로 포함
- `prev_area`는 SAM2 채택 후 `cache_good_result()`에서 설정됨 → 순환 의존
- 결과: 초반 프레임에서 SAM2 채택 불가 → 불필요한 상태 저하

### 수정 내용
1. **`qa/fusion.py` `_fuse_case_a_split()` ACTIVE 모드:**
   - `can_adopt`에서 `area_check_available` 제거
   - `area_check_available=False`일 때 quality -0.15 소프트 페널티
2. **`pipeline/runner.py` bbox sync (P4 ON 시):**
   - `prev_area` 없을 때 `area_ok=False` → `area_ok=True`로 변경

### 효과
- 초반 프레임부터 SAM2 채택 가능 (consensus + border_ok 조건은 유지)
- `cache_good_result()` 호출이 발생해 `prev_area` 생성 → 순환 해소
- area 참조 없으면 quality 소폭 감점으로 안전성 확보

---

## 메모
## TODO (미완성)
- 보수적 baseline 정책: 안정된 버그수정/개선은 ON, 위험한 실험은 OFF
- run_summary.json에 토글 상태가 기록되어 A/B 비교 시 어떤 조합이었는지 확인 가능
- GPT 제안(gpt_discussion/2026-02-04.md)의 Bundle 개념은 추후 프로파일 시스템으로 확장 가능
- GPT→Claude→GPT 3단 코드 점검 논의 완료. 합의된 우선순위: P0(순환의존)→P1(디버그정규화)→P2(ShapeStats통합)
