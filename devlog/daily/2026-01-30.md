# 2026-01-30 작업 기록

## GPT 논의 기반 개선 계획

GPT와 논의한 SAM2 추적 개선 방안 (`devlog/gpt_discussion/2026-01-30.md` 참조)

### 핵심 진단
1. **현재 Fusion 구조**: 점수 기반이 아닌 규칙+우선순위+게이트 기반
2. **부분 마스크 문제**: SAM2가 벌레 일부만 잡아도 center가 pred 근처면 "정상"으로 통과
3. **자기강화 루프**: 잘못된 SAM2 → KF 업데이트 → pred가 틀린 곳 → 맞는 SAM2도 거부
4. **재획득 약점**: 한 번 놓치면 정답을 다시 찾는 메커니즘 부재

### 개선 방향 (GPT 제안)
- ❌ **하드 게이트**: 오탐 위험 (웅크림/가림에서 정상 추적 끊음)
- ✅ **소프트 페널티 + 조건부 재획득**: 안전하고 효과적

### 작업 목록

| 순서 | 작업 | 상태 | 설명 |
|------|------|------|------|
| 1 | 멀티마스크 선택 개선 | ✅ 완료 | `argmax(score)` → 복합 점수 기반 |
| 2 | 연속성 페널티 (quality 감점) | ✅ 완료 | 면적/형태 급변 시 quality 감점 |
| 3 | UNCERTAIN 전이 조건 강화 | ✅ 완료 | quality 낮을 때 UNCERTAIN으로 전이 |
| 4 | 조건부 ROI 확장 | ✅ 완료 | UNCERTAIN/OCCLUDED에서 ROI+box 1.5배 확장 |
| 5 | 조건부 분기 ROI (dual hypothesis) | 대기 | 강한 의심 시 2가설 병렬 추적 |

---

## 완료된 작업

### 1. 멀티마스크 선택 개선 (커밋: `d000f6c`)

**문제**: `argmax(scores)`로 SAM2 점수만 보고 mask 선택 → 점수 높지만 엉뚱한 mask 선택 가능

**해결**: 복합 점수 기반 선택 함수 `_select_best_mask()` 구현

```python
combined = (
    sam2_score * 1.0           # SAM2 점수 (0~1)
    - dist_penalty * 0.3       # pred 거리 페널티 (최대 -0.3)
    - area_penalty             # 면적 일관성 페널티 (최대 -0.5)
    - border_touch * 0.3       # 경계 접촉 페널티 (최대 -0.3)
)
```

**고려 요소**:
- SAM2 confidence score (기본)
- Kalman 예측 위치와의 거리 (가까울수록 좋음)
- 이전 프레임 면적과의 일관성 (0.5~2배 범위 허용)
- ROI 경계 접촉 비율 (낮을수록 좋음)

**추가 구현**:
- `_prev_areas` 캐시: 이전 프레임 면적 저장
- `cache_good_result()` 수정: area도 함께 캐시

**테스트 결과**: 255프레임 모든 트랙 ACTIVE [SAM2] 유지

---

## 폴더 정리

### output 폴더 날짜별 정리
```
output/
├── 2026-01-16/  (1개 테스트)
├── 2026-01-28/  (6개 테스트)
├── 2026-01-29/  (17개 테스트)
└── 2026-01-30/  (오늘 테스트)
```

### devlog 구조 변경
```
devlog/
├── daily/           ← 날짜별 작업 기록
│   ├── 2026-01-27.md
│   ├── 2026-01-28.md
│   ├── 2026-01-29.md
│   └── 2026-01-30.md (이 파일)
└── gpt_discussion/  ← GPT 논의 내용
    └── 2026-01-30.md
```

---

## 커밋 이력

| 해시 | 설명 |
|------|------|
| `d000f6c` | Improve multimask selection with composite scoring |
| `d38eca1` | Add GPT discussion on SAM2 tracking improvements |
| `03495ca` | Reorganize devlog: daily/ and gpt_discussion/ |

---

---

### 2. 연속성 페널티 (면적 급변 시 quality 감점)

**파일**: `qa/fusion.py`

**구현**: 이전 프레임 대비 면적 비율이 0.5~2.0 범위 벗어나면 quality 감점

```python
area_penalty = 0.0
if prev_area is not None and curr_area is not None and prev_area > 0:
    area_ratio = curr_area / prev_area
    if area_ratio < 0.5:
        area_penalty = min((0.5 - area_ratio) * 0.8, 0.4)  # 너무 작으면 감점 (최대 0.4)
    elif area_ratio > 2.0:
        area_penalty = min((area_ratio - 2.0) * 0.4, 0.4)  # 너무 크면 감점 (최대 0.4)
```

---

### 3. UNCERTAIN 전이 조건 강화

**파일**: `qa/fusion.py`

**구현**: quality가 임계값(0.7) 미만이면 UNCERTAIN 힌트 반환

```python
quality_uncertain_th = float(qa.get("quality_uncertain_threshold", 0.7))
if adjusted_quality >= quality_uncertain_th:
    hint = TrackState.ACTIVE
else:
    hint = TrackState.UNCERTAIN
```

---

### 4. 조건부 ROI 확장 (재획득)

**문제**: UNCERTAIN/OCCLUDED 상태에서 벌레가 ROI 밖으로 이동하면 재획득 불가

**해결**: UNCERTAIN/OCCLUDED 상태에서 ROI와 SAM2 box prompt를 1.5배 확장

**수정 파일**:
- `roi/roi_manager.py`: `expansion_factor` 파라미터 추가
- `pipeline/runner.py`: 상태에 따라 expansion 값 결정
- `sensors/sam2_sensor.py`: `box_expansion` 파라미터 추가

```python
# roi_manager.py
def make_roi(self, cx: float, cy: float, frame_size: Tuple[int, int],
             expansion_factor: float = 1.0) -> RoiWindow:
    expanded_size = int(self.base_size * expansion_factor)
    size = max(self.min_size, min(expanded_size, self.max_size))

# runner.py
if tr.state in (TrackState.UNCERTAIN, TrackState.OCCLUDED):
    expansion = 1.5
else:
    expansion = 1.0
roi = roi_mgr.make_roi(pred_center[0], pred_center[1], frame_size,
                       expansion_factor=expansion)
sam2_result = sam2_sensor.measure(tr, roi, crop_bgr, crop_gray, frame_idx,
                                  box_expansion=expansion)

# sam2_sensor.py
half_w = int(seed_w * box_expansion) // 2
half_h = int(seed_h * box_expansion) // 2
```

**테스트 결과**: track 1이 OCCLUDED 상태에서 1-5 프레임 내에 재획득 성공

---

### 5. SAM2 마스크 오버레이 시각화

**문제**: SAM2가 무엇을 추적하는지 시각적으로 확인 불가 → 디버깅 어려움

**해결**: overlay에 SAM2 마스크를 색상으로 시각화

**수정 파일**: `io_utils/overlay.py`
- `DebugInfo`에 `sam2_mask` 필드 추가
- 트랙별 고유 색상으로 마스크 오버레이 (초록/파랑/빨강)
- 50% 투명도로 원본 영상과 합성

---

### 6. 속도 기반 ROI 확장

**문제**: 벌레가 빠르게 움직이면 ROI를 벗어나 SAM2가 배경을 잡음

**해결**: 이동량 기반으로 ROI 미리 확장 (벗어나기 전에 대응)

**구현**:
```python
# 속도 비율 계산
r = dist / roi_base_size

# 확장 결정
if r > 0.40:
    speed_expansion = 2.0
elif r > 0.25:
    speed_expansion = 1.5

# 최종: 상태 기반과 속도 기반 중 큰 값
expansion = max(state_expansion, speed_expansion)
```

**히스테리시스 (pumping 방지)**:
- 확장 시 쿨다운 5프레임 설정
- 쿨다운 중에는 최소 1.5배 유지

**수정 파일**:
- `pipeline/runner.py`: 속도 기반 확장 + 쿨다운 로직
- `tracking/track.py`: `expansion_cooldown` 필드 추가

---

## 커밋 이력 (추가)

| 해시 | 설명 |
|------|------|
| `0c77efc` | Add quality threshold for UNCERTAIN state transition |
| `6409048` | Add area continuity penalty to quality score |

---

## 다음 작업 예정

1. **조건부 분기 ROI (dual hypothesis)**: 강한 의심 시 2가설 병렬 추적
2. **QA fusion 문제 분석**: SAM2 마스크가 정확해도 bbox가 업데이트되지 않는 문제
