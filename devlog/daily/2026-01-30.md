# 2026-01-30 작업 기록

## GPT 논의 기반 개선 계획

GPT와 논의한 SAM2 추적 개선 방안 (`devlog/gpt_discussion/2026-01-30.md` 참조)

### 핵심 진단
1. **현재 Fusion 구조**: 점수 기반이 아닌 규칙+우선순위+게이트 기반
2. **부분 마스크 문제**: SAM2가 벌레 일부만 잡아도 center가 pred 근처면 "정상"으로 통과
3. **자기강화 루프**: 잘못된 SAM2 → KF 업데이트 → pred가 틀린 곳 → 맞는 SAM2도 거부
4. **재획득 약점**: 한 번 놓치면 정답을 다시 찾는 메커니즘 부재

### 개선 방향 (GPT 제안)
- ❌ **하드 게이트**: 오탐 위험 (웅크림/가림에서 정상 추적 끊음)
- ✅ **소프트 페널티 + 조건부 재획득**: 안전하고 효과적

### 작업 목록

| 순서 | 작업 | 상태 | 설명 |
|------|------|------|------|
| 1 | 멀티마스크 선택 개선 | ✅ 완료 | `argmax(score)` → 복합 점수 기반 |
| 2 | 연속성 페널티 (quality 감점) | 대기 | 면적/형태 급변 시 quality 감점 |
| 3 | UNCERTAIN 전이 조건 강화 | 대기 | quality 낮을 때 UNCERTAIN으로 전이 |
| 4 | 조건부 ROI 확장 | 대기 | UNCERTAIN에서 ROI 확장하여 재탐색 |
| 5 | 조건부 분기 ROI (dual hypothesis) | 대기 | 강한 의심 시 2가설 병렬 추적 |

---

## 완료된 작업

### 1. 멀티마스크 선택 개선 (커밋: `d000f6c`)

**문제**: `argmax(scores)`로 SAM2 점수만 보고 mask 선택 → 점수 높지만 엉뚱한 mask 선택 가능

**해결**: 복합 점수 기반 선택 함수 `_select_best_mask()` 구현

```python
combined = (
    sam2_score * 1.0           # SAM2 점수 (0~1)
    - dist_penalty * 0.3       # pred 거리 페널티 (최대 -0.3)
    - area_penalty             # 면적 일관성 페널티 (최대 -0.5)
    - border_touch * 0.3       # 경계 접촉 페널티 (최대 -0.3)
)
```

**고려 요소**:
- SAM2 confidence score (기본)
- Kalman 예측 위치와의 거리 (가까울수록 좋음)
- 이전 프레임 면적과의 일관성 (0.5~2배 범위 허용)
- ROI 경계 접촉 비율 (낮을수록 좋음)

**추가 구현**:
- `_prev_areas` 캐시: 이전 프레임 면적 저장
- `cache_good_result()` 수정: area도 함께 캐시

**테스트 결과**: 255프레임 모든 트랙 ACTIVE [SAM2] 유지

---

## 폴더 정리

### output 폴더 날짜별 정리
```
output/
├── 2026-01-16/  (1개 테스트)
├── 2026-01-28/  (6개 테스트)
├── 2026-01-29/  (17개 테스트)
└── 2026-01-30/  (오늘 테스트)
```

### devlog 구조 변경
```
devlog/
├── daily/           ← 날짜별 작업 기록
│   ├── 2026-01-27.md
│   ├── 2026-01-28.md
│   ├── 2026-01-29.md
│   └── 2026-01-30.md (이 파일)
└── gpt_discussion/  ← GPT 논의 내용
    └── 2026-01-30.md
```

---

## 커밋 이력

| 해시 | 설명 |
|------|------|
| `d000f6c` | Improve multimask selection with composite scoring |
| `d38eca1` | Add GPT discussion on SAM2 tracking improvements |
| `03495ca` | Reorganize devlog: daily/ and gpt_discussion/ |

---

## 다음 작업 예정

1. **연속성 페널티**: 면적/형태 급변 시 quality_score 감점
2. **UNCERTAIN 전이 조건 강화**: 감점된 quality로 상태 전이 유도
3. **조건부 ROI 확장**: UNCERTAIN에서 재획득 시도
