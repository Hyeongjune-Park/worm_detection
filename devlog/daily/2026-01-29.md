# 2026-01-29 작업 기록

## SAM2 Box Prompt 피드백 루프 버그 수정

### 문제 현상
- SAM2가 감지한 bbox 면적이 4,859 → 100,000+ 로 무한 성장
- 추적 대상이 아닌 배경 전체를 세그먼트
- 시드 박스를 조금만 다르게 그려도 추적 실패

### 근본 원인 분석

1. **Box prompt 위치 오류**: 이전 프레임의 SAM2 bbox 중심을 다음 프레임 box prompt로 사용
   - SAM2가 배경을 잘못 세그먼트하면 → 그 중심이 다음 box prompt가 됨 → 더 큰 배경 세그먼트 → 양성 피드백 루프

2. **Box prompt 크기 피드백**: SAM2 결과 bbox 크기가 다음 프레임 box prompt 크기에 반영
   - 큰 mask → 큰 box prompt → 더 큰 mask

### Fix 1: Box prompt 중심을 Kalman 예측 위치로 변경
- **파일**: `sensors/sam2_sensor.py`
- **변경 전**: 이전 SAM2 bbox 중심 사용
- **변경 후**: `track.kf.get_position()` (Kalman 예측 위치) 사용
- **효과**: Kalman 필터가 예측한 위치에서 벌레를 찾으므로 피드백 루프 차단

### Fix 2: Box prompt 크기를 시드 박스 크기로 제한
- **파일**: `sensors/sam2_sensor.py`, `tracking/track.py`, `pipeline/runner.py`
- **변경 전**: 이전 SAM2 결과 또는 고정 크기 사용
- **변경 후**: 사용자가 처음 지정한 시드 박스 크기(`seed_bbox_size`)를 상한으로 사용
- **근거**: 사용자가 시드 지정 시 벌레 전체를 감싸도록 그리므로, 그 크기가 벌레 최대 크기의 합리적 상한

### Fix 3: Point prompt도 Kalman 예측 위치 사용
- **파일**: `sensors/sam2_sensor.py`
- Box prompt와 동일하게 Kalman 예측 위치를 point prompt로 전달
- SAM2에게 "이 위치에서 객체를 찾아라"는 일관된 힌트 제공

## 디버그 시각화 추가

### 오버레이에 센서별 위치 표시
- **파일**: `io_utils/overlay.py`, `pipeline/runner.py`
- **추가 요소**:
  - ROI 영역: 하늘색(cyan) 사각형
  - Kalman 예측 위치: 흰색 X 마커
  - SAM2 중심: 녹색 원
  - Template 중심: 파란색 사각형
  - KLT 중심: 빨간색 마름모

### DebugInfo 데이터클래스
```python
@dataclass
class DebugInfo:
    track_id: int
    roi: Optional[Tuple[int, int, int, int]] = None
    pred_center: Optional[Tuple[float, float]] = None
    sam2_center: Optional[Tuple[float, float]] = None
    tpl_center: Optional[Tuple[float, float]] = None
    klt_center: Optional[Tuple[float, float]] = None
```

## Track 데이터 모델 확장

- **파일**: `tracking/track.py`
- **추가 필드**: `seed_bbox_size: Optional[Tuple[int, int]]`
- 시드 박스의 (width, height)를 저장하여 SAM2 box prompt 크기 제한에 활용

## 시드 박스 재설정

기존 시드가 너무 크거나 부정확하여 재설정:

| Track | 이전 | 현재 | 크기 |
|-------|------|------|------|
| 1 | - | (957, 421, 1114, 741) | 157×320 |
| 2 | - | (1364, 162, 1609, 363) | 245×201 |
| 3 | - | (1504, 596, 1758, 700) | 254×104 |

## 폐기된 시도

### 면적 기반 mask 선택 로직
- SAM2의 3개 mask 중 면적이 너무 큰 것을 거부하는 로직 추가 시도
- 첫 프레임에서 상한 계산이 부정확하여 정상 mask도 거부하는 문제 발생
- **결론**: Kalman 예측 위치 기반 box/point prompt만으로 충분히 안정적이므로 제거

## 최종 결과

| Track | Area 범위 | 상태 | 프레임 |
|-------|----------|------|--------|
| 1 | 12,700-14,600 | ACTIVE [SAM2] | 255/255 |
| 2 | 8,100-8,700 | ACTIVE [SAM2] | 255/255 |
| 3 | 5,800-6,000 | ACTIVE [SAM2] | 255/255 |

모든 트랙이 전체 프레임에서 SAM2 기반 추적 유지.

## 커밋

- `3c584b8`: Fix SAM2 box prompt: use Kalman prediction + seed bbox size limit
