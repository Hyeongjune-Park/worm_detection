# 2026-02-06 작업 기록

## TODO

- [x] **Baseline 기반 이상 감지 시스템 구현**
- [x] **WIDTH_CV_BLOWUP false positive 수정** (v1 - 불충분)
  - Track 3 분석 결과: 첫 프레임 width_cv=0.22로 비정상적으로 낮음
  - 이후 정상 프레임(0.35~0.50)이 모두 WIDTH_CV_BLOWUP으로 감지됨
  - 시도 1: baseline width_cv에 최소값(floor) 0.25 적용 → 82% 여전히 초과
  - **문제**: width_cv는 프레임마다 변동이 크고 (median 0.61), 상대비교 부적합
- [x] **WIDTH_CV_BLOWUP 절대값 임계값으로 변경**
  - Good 프레임 median=0.60, Bad 프레임(번짐) median=0.99
  - 해결: 상대비교(2x baseline) 대신 절대값(> 0.85) 사용
  - 결과: Track 3 플래그 227 → 8 (97% 감소)
  - 수정: `_detect_anomalies()`에서 `WIDTH_CV_HIGH` 플래그로 변경
- [x] **스냅샷 시각화 개선**
  - 현재: 텍스트만 오버레이 → 가독성 낮음
  - 요청: overlay 영상처럼 마스크/추적점 표시 + 트랙 ID 옆에 shape 정보
  - 수정 내용:
    - SAM2 마스크 반투명 오버레이 (트랙별 색상)
    - 센서별 마커: PRED(흰X), SAM2(녹원), TPL(파란네모), KLT(빨간마름모)
    - ROI 사각형 (하늘색)
    - 트랙 라벨 근처에 shape 정보 (ss, tf, wcv)
    - 플래그는 화면 좌하단에 표시
  - 수정 파일: `debug_logger.py`, `runner.py`
  - 테스트: `output/2026-02-06/04_snapshot_vis/` (264개 스냅샷)
- [x] **스냅샷 전환점 방식으로 변경**
  - 문제: 모든 플래그 프레임 저장 → 264개 과다
  - 해결: 상태 전환점에서만 3장(before, event, after) 저장
    - clean→flagged 전환: problem_start
    - flagged→clean 전환: problem_end
  - 파일명: `001_T2_before_problem_start_F0007.png` 형식
  - 결과: 264개 → **90개** (30개 전환점 × 3장)
  - 수정: `DebugLogger.handle_snapshot_transition()` 추가
  - 테스트: `output/2026-02-06/05_snapshot_transitions/`
- [x] **스냅샷 최소 지속 필터 (5프레임)**
  - 문제: 1~2프레임 노이즈도 전환으로 캡처됨 (90개)
  - 해결: 5프레임 이상 지속될 때만 전환으로 인정
  - 버퍼: 마지막 6프레임 저장하여 확인 후 저장
  - 결과: **264개 → 12개** (4개 전환점 × 3장)
  - 수정: `handle_snapshot_transition()`, `_confirm_and_save_transition()` 추가
  - 테스트: `output/2026-02-06/07_5frame_fixed/`
- [x] **플래그 종류 변화도 전환으로 인식**
  - 기존: 플래그 유무만 추적 (boolean has_flags)
  - 문제: AREA_BLOWUP → THICKNESS_BLOWUP 전환 시 스냅샷 없음
  - 해결: 플래그 타입 집합(frozenset)으로 추적
    - `_extract_flag_types()`: 플래그 리스트에서 타입만 추출
    - `confirmed_flag_set`: boolean 대신 frozenset 저장
    - 전환 조건 3가지:
      1. `problem_start`: clean → flagged
      2. `problem_end`: flagged → clean
      3. `problem_change`: 새 플래그 타입 등장 (예: AREA→THICKNESS)
  - 수정 파일: `debug_logger.py`

---

## 작업 내용

### Baseline 시스템 설계

**문제점**: 현재 `THICKNESS_HIGH > 60px` 같은 절대값 기준은 영상/벌레마다 다름

**해결책**: 첫 프레임 SAM2 결과를 baseline으로 삼아 상대적 변화 감지

**저장할 baseline 항목** (트랙별):
| 항목 | 용도 |
|------|------|
| area | 면적 급변 감지 |
| thickness_med | 두께 급변 감지 |
| thickness_p90 | 두께 급변 감지 |
| tube_fit | 형태 변화 감지 |
| width_cv | 체폭 일관성 변화 |

**이상 감지 기준**:
- area > 3x 또는 < 0.3x (baseline 대비) → AREA_BLOWUP
- thickness_p90 > 2x (baseline 대비) → THICKNESS_BLOWUP
- tube_fit < 0.5x (baseline 대비) → TUBE_FIT_DEGRADE
- width_cv > 0.85 (**절대값**) → WIDTH_CV_HIGH

---

## 수정 완료

### 1. debug_logger.py

- `TrackBaseline` dataclass 추가: 트랙별 기준값 저장
- `DebugLogger.set_baseline()` 메서드 추가: 첫 프레임에서 호출
- `_detect_anomalies()` 수정: baseline 대비 상대 비율로 플래그 생성
  - 기존 절대값 `THICKNESS_HIGH > 60px` 삭제
  - 새 플래그: `THICKNESS_BLOWUP`, `TUBE_FIT_DEGRADE`, `WIDTH_CV_BLOWUP`
  - `CENTER_JUMP` 임계값도 baseline.area 기반으로 동적 조정

### 2. runner.py

- ShapeStats 계산 후 `debug_logger.set_baseline()` 호출 추가
- 조건: `shape_score >= 0.8` (SAM2 품질 좋을 때만 baseline 설정)

---

## 테스트 결과 (01_baseline_anomaly)

| 플래그 | 이전 (절대값) | 현재 (baseline) |
|--------|-------------|----------------|
| THICKNESS | 221 | 227 |
| LOW_SHAPE_SCORE | 103 | 103 |
| AREA_BLOWUP | 3 | **145** |
| WIDTH_CV_BLOWUP | - | **281** |
| TUBE_FIT_DEGRADE | - | **153** |

baseline 기반 감지가 더 민감함. 플래그 총 개수 증가.

**추적 결과**: 이전과 동일 (NEEDS_RESEED 1개, Track 2)

---

## 수정된 파일

- `io_utils/debug_logger.py`
- `pipeline/runner.py`

## 테스트 출력

- `output/2026-02-06/01_baseline_anomaly/`
- `output/2026-02-06/03_wcv_absolute/` (WIDTH_CV_HIGH 수정 후)

---

## WIDTH_CV 절대값 임계값 수정 결과 (03_wcv_absolute)

### 문제점 발견

Track 3 분석 결과:
- 첫 프레임 width_cv = 0.22 (비정상적으로 낮음)
- 정상 운영 범위 = 0.35 ~ 0.70 (median 0.61)
- 2x 상대 임계값 = 0.44 → 82%가 초과하여 false positive

### 해결책

상대 비교(2x baseline) 대신 **절대값 임계값(> 0.85)** 사용

근거: 이전 skeleton 분석에서 Good median=0.60, Bad(번짐) median=0.99

### 최종 결과

| Track | Flagged Frames | 상태 | 판정 |
|-------|----------------|------|------|
| Track 1 | 199/255 | OCCLUDED 다수 | ✓ 실제 번짐 |
| Track 2 | 57/64 | NEEDS_RESEED | ✓ 조기 실패 |
| Track 3 | **8/255** | 모두 ACTIVE, q=1.00 | ✓ 정상 추적 |

Track 3: 227 → 8 flagged (97% 감소), 모든 플래그가 실제로 width_cv가 높은 프레임

---

## 플래그 타입 변화 감지 (08_flag_type_change)

### 기존 문제

`handle_snapshot_transition()`이 `has_flags` boolean만 추적:
- `AREA_BLOWUP` → `THICKNESS_BLOWUP` 전환 시 스냅샷 없음
- 문제 유형이 바뀌는 순간의 특징을 파악할 수 없음

### 해결책

플래그 타입을 `frozenset`으로 추적:

```python
def _extract_flag_types(self, reason_flags: List[str]) -> frozenset:
    """플래그에서 타입만 추출 (값 제거)."""
    # ["AREA_BLOWUP_UP(3.5x)"] -> frozenset({"AREA_BLOWUP_UP"})
    return frozenset(f.split("(")[0] for f in reason_flags if f)
```

### 전환 조건 3가지

| 타입 | 조건 | 예시 |
|------|------|------|
| `problem_start` | clean → flagged | `{}` → `{AREA_BLOWUP}` |
| `problem_end` | flagged → clean | `{AREA_BLOWUP}` → `{}` |
| `problem_change` | 새 플래그 등장 | `{AREA}` → `{AREA, THICKNESS}` |

### 변경된 데이터 구조

```python
# 기존
self.confirmed_state: Dict[int, bool] = {}
self.pending_transition: Dict[int, Tuple[int, str]] = {}

# 변경
self.confirmed_flag_set: Dict[int, frozenset] = {}
self.pending_transition: Dict[int, Tuple[int, str, frozenset]] = {}
```

---

## Toggle A/B 테스트 (진행중)

### 테스트 환경
- 영상: `video/short.mp4` (255프레임, 3트랙)
- 스크립트: `toggle_ab_test.py` (17개 단일 토글 테스트)

### 결과 요약 (단일 토글)

**Baseline**: ACTIVE=383, OCCLUDED=176, RESEED=1, SAM2=405

| Toggle | ACTIVE | OCCLUDED | RESEED | 판정 |
|--------|--------|----------|--------|------|
| **SH1_shape_gate_OFF** | **714 (+331)** | **27** | **0** | Best - 너무 엄격했나? |
| P2_state_roi_ON | 526 (+143) | 96 | 1 | 균형 잡힌 개선 |
| F3_strict_OFF | 565 (+182) | 72 | 1 | 위험 - 버그수정 되돌림 |
| F2_soft_pred_ON | 489 (+106) | 141 | 1 | 중간 정도 개선 |
| P4_bbox_sync_ON | 452 (+69) | 295 | 0 | 모든 트랙 생존 |
| S3_klt_reinit_OFF | 424 (+41) | 136 | 1 | 약간 개선 |
| P1_speed_roi_ON | 383 (±0) | 176 | 1 | 효과 없음 |
| S2_tpl_gate_OFF | 383 (±0) | 176 | 1 | 효과 없음 |
| F1_split_OFF | 329 (-54) | 114 | 2 | 해로움 |
| F4_area_penalty_ON | 318 (-65) | 126 | 2 | 해로움 |
| S4_cache_OFF | 274 (-109) | 77 | 2 | 해로움 |
| S1_composite_OFF | 283 (-100) | 68 | 2 | 해로움 |
| F5_recovery_OFF | 265 (-118) | 56 | 2 | 해로움 |

**미완료**: K1_vel_decay_OFF, SM1_occ_recovery_ON

### 핵심 발견

1. **SH1 (shape_quality_gate)가 너무 엄격함**: OFF 시 ACTIVE 거의 2배 증가
   - 좋은 SAM2 결과도 shape_score < 0.8로 거부되고 있을 가능성
   - 임계값 조정 (0.8 → 0.6) 또는 OFF 후 overlay 품질 확인 필요
2. **P2 (state_roi_expansion)**: 안정적 개선 (+143 ACTIVE)
3. **P4 (sam2_bbox_sync)**: RESEED 0 달성하지만 OCCLUDED 높음

### TODO (내일)
- [ ] K1, SM1 단일 토글 테스트 완료
- [ ] 유망 조합 테스트: P2+SH1_OFF, P4+SH1_OFF, P2+P4+SH1_OFF
- [ ] SH1_OFF의 overlay 영상 확인 (실제 추적 품질 검증)
- [ ] SH1 임계값 조정 방안 검토 (OFF 대신 0.8→0.6 완화)
- [ ] 최적 조합 확정 후 config.yaml 기본값 변경
