# 2026-02-05 작업 기록

## 오늘의 작업

| 순서 | 작업 | 상태 | 설명 |
|------|------|------|------|
| 1 | P2 shape gate 튜닝 | 완료 | 01~05 테스트 (이전 세션에서 진행) |
| 2 | Skeleton 분석 연구 | 완료 | scikit-image skeletonize 기반 애벌레 형태 판별 |
| 3 | shape_analyzer 통합 | 완료 | tube_fit, width_cv 특성 추가 + 점수 계산 |
| 4 | 통합 테스트 | 완료 | 06_skeleton_integration |

---

## P2 Shape Gate 진행 요약 (01~05)

이전 세션에서 shape_score 기반 SAM2 거부 로직을 5차례 튜닝:
- 01: 소프트 페널티만 -> 효과 없음
- 02: ROI 정규화 임계값 -> 여전히 효과 없음
- 03: 하드 거부 (< 0.5) -> 부분 효과, 중심 여전히 틀림
- 04: 공격적 임계값 (< 0.6) -> 트랙 사망
- 05: predict-only fallback -> 트랙 더 오래 생존하지만 여전히 사망

**근본 문제**: 기존 shape_score(aspect_ratio, thickness 등)는 "펴진 애벌레 vs blob"만 구분 가능. "말린 애벌레"와 "번짐"을 구분하지 못함.

---

## Skeleton 기반 형태 분석 연구

### 핵심 통찰

애벌레의 본질적 기하학 특성: **일정한 체폭을 가진 곡선 튜브**

펴져있든 말려있든, skeleton(중심축)을 따라 측정한 body width가 일정하다면 애벌레.

### 새로운 특성

1. **skel_tube_fit** = area / (skeleton_length * mean_width)
   - 완벽한 튜브 구조 = ~1.0
   - Good 프레임: median **0.98**
   - Bad 프레임 (번짐): median **0.37**

2. **skel_width_cv** = std(width) / mean(width)
   - 체폭 일관성 (coefficient of variation)
   - Good 프레임: median **0.60**
   - Bad 프레임: median **0.99**

### 합성 마스크 테스트 결과

| 형태 | tube_fit | width_cv | 판정 |
|------|----------|----------|------|
| 펴진 애벌레 | 0.93 | 0.26 | LARVA |
| 말린 애벌레(C) | 1.15 | 0.07 | LARVA |
| 말린 애벌레(S) | 1.16 | 0.08 | LARVA |
| 동그란 blob | 0.00 | 0.00 | BLOB |
| 불규칙 blob | 2.47 | 0.06 | BLOB |

**말린 애벌레도 정확히 구분 가능!**

### 실제 영상 분석 결과 (예상과 반대)

놀랍게도 실제 영상에서는:
- Good 프레임 (ss >= 0.8): worm_ratio **24.9** (낮음)
- Bad 프레임 (ss < 0.6): worm_ratio **106.4** (높음)

이유: 번짐은 "가늘고 긴 번짐" 형태로, skeleton이 매우 길지만 width가 불균일함.

**결론**: worm_ratio 단독 판별 불가, tube_fit + width_cv 조합이 핵심.

---

## shape_analyzer.py 수정 내용

### 추가된 필드 (ShapeStats)

```python
skel_length: int = 0
skel_worm_ratio: float = 0.0
skel_width_cv: float = 0.0
skel_tube_fit: float = 0.0
skel_branch_points: int = 0
```

### 점수 계산 로직

```python
skel_valid = _HAS_SKIMAGE and stats.skel_length >= 10 and stats.skel_tube_fit > 0

if skel_valid:
    # tube_fit < 0.5: 번짐 (skeleton 길지만 면적 안 맞음)
    if stats.skel_tube_fit < 0.5:
        score -= min((0.5 - stats.skel_tube_fit) * 2.0, 0.5)
    # tube_fit > 1.3: blob (skeleton 대비 면적 너무 큼)
    elif stats.skel_tube_fit > 1.3:
        score -= min((stats.skel_tube_fit - 1.3) * 0.6, 0.5)

    # width_cv > 0.85: 체폭 불균일 = 번짐 의심
    if stats.skel_width_cv > 0.85:
        score -= min((stats.skel_width_cv - 0.85) * 1.5, 0.4)
```

### 의존성 추가

```bash
pip install scikit-image
```

---

## 테스트 결과 (06_skeleton_integration)

### 이전 (05_p2_shape_pred_fallback) vs 현재 비교

| 항목 | 이전 | 현재 | 변화 |
|------|-----|------|------|
| NEEDS_RESEED tracks | 2 | **1** | 개선! |
| ACTIVE 프레임 | 365 | 383 | +18 |
| SAM2 사용 | 386 | 405 | +19 |
| LOW_SHAPE_SCORE 감지 | 2 | **103** | 훨씬 민감 |

**Track 1이 더 이상 사망하지 않음!**

Skeleton 기반 shape_score가 번짐을 더 정확히 감지하여 나쁜 SAM2 결과를 거부.

---

## 다음 단계

1. 실제 영상 시각 검토 (overlay.mp4)
2. debug logging 강화 (사용자 요청):
   - d_prev_center: 매 프레임 위치 변화량
   - shape 정보 overlay 표시
   - 상태 전이 시 스냅샷 캡처
   - 센서별 이동량 기록
3. P1 (디버그 플래그 ROI 정규화) - 필요시 진행

---

## 코드 변경 파일

- `qa/shape_analyzer.py` - skeleton 특성 + 점수 계산 통합
- requirements에 `scikit-image` 추가 필요

## 테스트 출력

- `output/2026-02-05/06_skeleton_integration/`
