# 2026-02-13 Daily Devlog

## TODO
- [x] Step 1: P5(box prompt 확장) + MC1+P2 조합 테스트
- [x] Step 2: Adaptive prompt box 설계 및 구현
- [x] Step 3: Adaptive prompt box 테스트 (단독 + MC1+P2 조합)
- [x] Step 4: 결과 비교 및 기록
- [x] 육안 검증 (overlay 비교)
- [ ] GitHub 업로드

## 작업 기록

### Step 1: P5+MC1+P2 테스트
- P5(reacquire_box_expansion) = P2의 ROI 확장을 SAM2 box prompt에도 적용
- 결과: **역대 최고 — ACTIVE=700, RESEED=0**

| Config | ACTIVE | OCCLUDED | RESEED | Changes |
|--------|--------|----------|--------|---------|
| MC1+P2 | 569 | 99 | 1 | 76 |
| **P5+MC1+P2** | **700** | **40** | **0** | **61** |

- P5 효과: +131 ACTIVE, OCCLUDED 절반 이하, 모든 트랙 255프레임 생존
- 핵심: ROI만 확장(P2)해선 부족, box prompt도 함께 확장해야 SAM2 재획득 성공

### Step 2: Adaptive Prompt Box (P6) 구현
- `tracking/track.py`: `prompt_bbox_size` 필드 추가
- `config_toggles.py` + `config.yaml`: `adaptive_prompt_box` 토글 (P6, 기본 OFF)
- `sensors/sam2_sensor.py`: prompt_bbox_size → seed_bbox_size fallback
- `pipeline/runner.py`: sam2_bbox_ok일 때 mask bbox → EMA(alpha=0.2) 갱신, seed 대비 [0.7x, 1.8x] clamp

### Step 3: P6 테스트 결과

| # | Config | ACTIVE | OCCLUDED | UNCERTAIN | RESEED | Changes |
|---|--------|--------|----------|-----------|--------|---------|
| 01 | MC1+P2 | 569 | 99 | 26 | 1 | 76 |
| 02 | P5+MC1+P2 | 700 | 40 | 25 | 0 | 61 |
| 03 | **P6 단독** | **740** | **17** | **8** | **0** | **37** |
| 04 | P6+MC1+P2 | 710 | 28 | 27 | 0 | 77 |
| 05 | P6+P5+MC1+P2 | 705 | 42 | 18 | 0 | 65 |

#### 분석
1. **P6 단독이 역대 최고**: ACTIVE=740, OCCLUDED=17, RESEED=0, Changes=37
2. P6 > P5+MC1+P2 > MC1+P2: adaptive box가 MC1/P2/P5의 역할을 대체
3. P6에 MC1이나 P5를 추가하면 오히려 성능 하락 (MC1이 mask를 과도 정리, P5가 box를 과도 확장)
4. Changes=37 (MC1+P2의 절반): 상태 전환이 적음 = 안정적 트래킹

### 육안 검증 결과

#### P6 OFF (MC1+P2 등)
- 파란 벌레: 대체로 잘 추적되나, bbox 내 풀잎의 밝고 둥근 특징 픽셀을 순간순간 노이즈로 감지
- 후반부: 마스킹은 유지되지만 bbox가 길쭉한 직사각형으로 벌레 형태를 포함하지 않게 됨 → NEEDS_RESEED

#### P6 ON
- **파란 벌레**: 노이즈 전혀 없이 명확한 마스킹. 꼬리 끝이 아주 작게 짤리지만 치명적이지 않음 (오히려 선호)
- **녹색 벌레 (모든 P6 변형)**: 첫 큰 상향 이동 추적 후 잎으로 튐 — 근본적 문제 지속
- P6는 확실한 개선이지만, SAM2가 벌레보다 잎의 특징 픽셀을 더 강하게 잡는 문제가 근본 원인

#### 결론
- **P6 단독을 새 baseline으로 채택** (config.yaml에서 P6=ON으로 변경)
- 다음 과제: SAM2가 큰 이동 후 잎으로 점프하는 근본 문제 해결 필요

