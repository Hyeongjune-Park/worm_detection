# GPT 논의 - 2026-02-04

## 논의 주제

---

# Feature Toggle Plan (2026-01-31)
## 목적
- 오늘 적용된 변경 중 “추적 악화/불확실”한 것들을 **기본 OFF**로 격리
- 이후 형태 기반 QA/재획득 로직과 결합해 **A/B 테스트 가능**하게 만들기
- “같이 켜야 의미 있는 기능”은 **묶음 토글(bundle)** 로 구성

---

## 0) 설계 원칙
1. **기본값은 보수적으로**: OFF가 기본 (안정 baseline 유지)
2. **오염 방지 우선**: shape_score/연속성 없이 prompt_bbox 업데이트를 공격적으로 만드는 기능은 항상 OFF 기본
3. **Bundle 우선**: 단독 ON이 의미 없거나 위험한 기능은 묶어서만 ON 가능
4. **로그 연동 필수**: 토글 ON/OFF 상태를 run_summary/debug_frames에 항상 기록

---

## 1) 토글 목록 (단일 기능 토글)

### T1. SAM2 bbox 동기화(단일) - 위험, 기본 OFF
- **ID**: `TOGGLE_SAM2_BBOX_SYNC`
- **목적**: SAM2 마스크가 “정상”일 때 bbox를 SAM2 bbox로 동기화해 drift 차단
- **리스크**: SAM2가 배경을 잡은 순간 bbox/prompt 오염을 가속 → 풀마스크 유발
- **필수 전제**: shape/연속성 검증(=Bundle B2)이 없으면 절대 단독 ON 금지
- **권장 상태**: OFF (Bundle B2 켠 경우에만 ON)

---

### T2. pred_ok 소프트 페널티(R 증가 + quality 감점) - 위험, 기본 OFF
- **ID**: `TOGGLE_SOFT_PRED_PENALTY`
- **목적**: pred 거리 기반 “거부” 대신 “덜 믿는 관측”으로 처리
- **리스크**: pred가 틀린 프레임에서 R 증가 → 관측 무시 → 악순환 가능
- **필수 전제**: shape/연속성 점수로 관측 자체를 QA하는 계층(=Bundle B2)
- **권장 상태**: OFF (Bundle B2 이후 시험)

---

### T3. 속도 기반 ROI 확장 - 조건부, 기본 OFF
- **ID**: `TOGGLE_SPEED_ROI_EXPANSION`
- **목적**: 급이동 시 ROI를 미리 확장해 ROI 탈출/재획득 실패 감소
- **리스크**: pred가 틀린 상황에 ROI가 커지면 풀마스크 위험 급증
- **필수 전제**: “UNCERTAIN/REACQUIRE에서는 확장 금지” 브레이크(=Bundle B3)
- **권장 상태**: OFF → Bundle B3로만 ON

---

### T4. secondary_ok 정의 수정(센서 None을 ok로 보지 않기) - 안정화, 기본 ON 권장
- **ID**: `TOGGLE_STRICT_SECONDARY_OK`
- **목적**: TPL/KLT 없을 때 secondary_ok가 자동 True가 되는 문제 차단
- **효과**: SAM2 무제한 채택(견제 붕괴) 방지
- **권장 상태**: ON (이건 롤백 대상이 아니라 “복구/수정”에 가까움)

---

### T5. ACTIVE vs REACQUIRE 정책 분리 - 안정화, 기본 ON 권장(단 구현 상태에 따라)
- **ID**: `TOGGLE_STATE_POLICY_SPLIT`
- **목적**: 평상시(Active)와 재획득(Reacquire)에서 채택 규칙을 분리
- **효과**: Active에서 SAM2 단독 채택/급오염 방지, Reacquire에서는 재획득 허용
- **권장 상태**: ON (상태머신이 있다면 기본)

---

## 2) 묶음 토글(Bundle) — “같이 켜야 의미가 있는 기능”

### B1. Debug/Telemetry Bundle (필수 기반)
- **ID**: `BUNDLE_DEBUG_TELEMETRY`
- **포함 기능**
  - `debug_frames.jsonl` + `debug_frames.csv` 출력
  - `events.md` 자동 생성
  - `snapshots/` Top-K 이벤트 프레임 저장
  - 플래그(reason_flags) 생성 및 run_summary 기록
- **이유**: 토글 A/B 실험을 하려면 반드시 “증거”가 남아야 함
- **기본값**: ON (가능하면 항상 ON)

---

### B2. Prompt Poisoning Guard (형태 기반 QA + prompt_bbox 보호) — 핵심, 기본 OFF(완성 후 ON)
- **ID**: `BUNDLE_PROMPT_POISON_GUARD`
- **포함 기능**
  1) `worm_shape_score` 계산 (ELONGATED/COILED 포함)
  2) `temporal_score`(연속성) 계산
  3) **prompt_bbox 업데이트 정책**
     - `final_score` 낮으면 `prompt_bbox_update=HOLD`
     - `last_good_bbox/mask` 유지
  4) 오염 위험 플래그
     - `PROMPT_POISON_RISK` (score 낮은데 UPDATE 시도)
- **이유(묶어야 하는 이유)**
  - shape/연속성 없이 bbox sync나 soft penalty를 켜면 오염/풀마스크로 악화 가능
  - 이 Bundle이 있어야 “공격적 기능들”을 안전하게 시험 가능
- **기본값**: OFF (구현 완료 후 ON)

---

### B3. ROI Safety Brake Bundle (ROI 확장/탐색의 안전장치) — 기본 OFF(ROI 확장 실험 시 ON)
- **ID**: `BUNDLE_ROI_SAFETY_BRAKE`
- **포함 기능**
  1) `TOGGLE_SPEED_ROI_EXPANSION`의 브레이크:
     - UNCERTAIN/REACQUIRE에서는 확장 금지 또는 상한
     - `|pred - best_obs|` 큰 프레임에서는 확장 금지
  2) `ROI_EXPAND_DURING_UNCERTAIN` 플래그
  3) ROI cooldown/히스테리시스(펌핑 방지)
- **이유**
  - ROI 확장은 급이동에서 도움되지만, 불일치 프레임에서 치명적
  - 안전 브레이크 없이 단독 ON은 위험
- **기본값**: OFF (ROI 확장 실험 시에만 ON)

---

### B4. Dual Hypothesis Reacquire Bundle (2-가설 분기 재획득) — 기본 OFF(나중에)
- **ID**: `BUNDLE_DUAL_HYPOTHESIS_REACQUIRE`
- **포함 기능**
  1) 분기 트리거(급점프/급변/ID switch 의심)
  2) H1(Follow SAM2) vs H2(Follow Secondary)로 짧게(2~3프레임) 실행
  3) `final_score` 기반 승자 선택 + 연속 승리 시 ACTIVE 복귀
  4) 패자 가설 결과는 prompt_bbox/메모리에 반영 금지
- **전제**
  - B2(형태/연속성 기반 QA + prompt 보호)가 먼저 있어야 안전
- **기본값**: OFF

---

## 3) “단독 ON 금지” 관계(강제 규칙)
- `TOGGLE_SAM2_BBOX_SYNC`는 **BUNDLE_PROMPT_POISON_GUARD(B2)** 없으면 ON 금지
- `TOGGLE_SOFT_PRED_PENALTY`는 **B2** 없으면 ON 금지
- `TOGGLE_SPEED_ROI_EXPANSION`은 **BUNDLE_ROI_SAFETY_BRAKE(B3)** 없으면 ON 금지
- `BUNDLE_DUAL_HYPOTHESIS_REACQUIRE(B4)`는 **B2** 없으면 ON 금지

---

## 4) 추천 기본 프로파일(실험 시작점)
### Profile P0: Baseline 안정
- B1 ON
- T4 ON, T5 ON
- B2/B3/B4 OFF
- (오늘 악화된 기능들 모두 OFF)

### Profile P1: Prompt 오염 방지 + 형태 점수 테스트
- P0 + B2 ON
- 나머지 공격적 기능(ROI 확장/soft penalty/bbox sync) OFF

### Profile P2: ROI 확장 실험(안전 브레이크 포함)
- P1 + B3 ON + T3 ON
- 결과 지표: AREA_BLOWUP, BORDER_TOUCH_HIGH 증가 여부 확인

### Profile P3: Dual hypothesis 재획득 실험
- P1 + B4 ON
- 결과 지표: REACQUIRE 성공률, ID_SWITCH_SUSPECT 감소 여부 확인
