# GPT 논의 - 2026-02-04

## 논의 주제

---

# Feature Toggle Plan (2026-01-31)
## 목적
- 오늘 적용된 변경 중 “추적 악화/불확실”한 것들을 **기본 OFF**로 격리
- 이후 형태 기반 QA/재획득 로직과 결합해 **A/B 테스트 가능**하게 만들기
- “같이 켜야 의미 있는 기능”은 **묶음 토글(bundle)** 로 구성

---

## 0) 설계 원칙
1. **기본값은 보수적으로**: OFF가 기본 (안정 baseline 유지)
2. **오염 방지 우선**: shape_score/연속성 없이 prompt_bbox 업데이트를 공격적으로 만드는 기능은 항상 OFF 기본
3. **Bundle 우선**: 단독 ON이 의미 없거나 위험한 기능은 묶어서만 ON 가능
4. **로그 연동 필수**: 토글 ON/OFF 상태를 run_summary/debug_frames에 항상 기록

---

## 1) 토글 목록 (단일 기능 토글)

### T1. SAM2 bbox 동기화(단일) - 위험, 기본 OFF
- **ID**: `TOGGLE_SAM2_BBOX_SYNC`
- **목적**: SAM2 마스크가 “정상”일 때 bbox를 SAM2 bbox로 동기화해 drift 차단
- **리스크**: SAM2가 배경을 잡은 순간 bbox/prompt 오염을 가속 → 풀마스크 유발
- **필수 전제**: shape/연속성 검증(=Bundle B2)이 없으면 절대 단독 ON 금지
- **권장 상태**: OFF (Bundle B2 켠 경우에만 ON)

---

### T2. pred_ok 소프트 페널티(R 증가 + quality 감점) - 위험, 기본 OFF
- **ID**: `TOGGLE_SOFT_PRED_PENALTY`
- **목적**: pred 거리 기반 “거부” 대신 “덜 믿는 관측”으로 처리
- **리스크**: pred가 틀린 프레임에서 R 증가 → 관측 무시 → 악순환 가능
- **필수 전제**: shape/연속성 점수로 관측 자체를 QA하는 계층(=Bundle B2)
- **권장 상태**: OFF (Bundle B2 이후 시험)

---

### T3. 속도 기반 ROI 확장 - 조건부, 기본 OFF
- **ID**: `TOGGLE_SPEED_ROI_EXPANSION`
- **목적**: 급이동 시 ROI를 미리 확장해 ROI 탈출/재획득 실패 감소
- **리스크**: pred가 틀린 상황에 ROI가 커지면 풀마스크 위험 급증
- **필수 전제**: “UNCERTAIN/REACQUIRE에서는 확장 금지” 브레이크(=Bundle B3)
- **권장 상태**: OFF → Bundle B3로만 ON

---

### T4. secondary_ok 정의 수정(센서 None을 ok로 보지 않기) - 안정화, 기본 ON 권장
- **ID**: `TOGGLE_STRICT_SECONDARY_OK`
- **목적**: TPL/KLT 없을 때 secondary_ok가 자동 True가 되는 문제 차단
- **효과**: SAM2 무제한 채택(견제 붕괴) 방지
- **권장 상태**: ON (이건 롤백 대상이 아니라 “복구/수정”에 가까움)

---

### T5. ACTIVE vs REACQUIRE 정책 분리 - 안정화, 기본 ON 권장(단 구현 상태에 따라)
- **ID**: `TOGGLE_STATE_POLICY_SPLIT`
- **목적**: 평상시(Active)와 재획득(Reacquire)에서 채택 규칙을 분리
- **효과**: Active에서 SAM2 단독 채택/급오염 방지, Reacquire에서는 재획득 허용
- **권장 상태**: ON (상태머신이 있다면 기본)

---

## 2) 묶음 토글(Bundle) — “같이 켜야 의미가 있는 기능”

### B1. Debug/Telemetry Bundle (필수 기반)
- **ID**: `BUNDLE_DEBUG_TELEMETRY`
- **포함 기능**
  - `debug_frames.jsonl` + `debug_frames.csv` 출력
  - `events.md` 자동 생성
  - `snapshots/` Top-K 이벤트 프레임 저장
  - 플래그(reason_flags) 생성 및 run_summary 기록
- **이유**: 토글 A/B 실험을 하려면 반드시 “증거”가 남아야 함
- **기본값**: ON (가능하면 항상 ON)

---

### B2. Prompt Poisoning Guard (형태 기반 QA + prompt_bbox 보호) — 핵심, 기본 OFF(완성 후 ON)
- **ID**: `BUNDLE_PROMPT_POISON_GUARD`
- **포함 기능**
  1) `worm_shape_score` 계산 (ELONGATED/COILED 포함)
  2) `temporal_score`(연속성) 계산
  3) **prompt_bbox 업데이트 정책**
     - `final_score` 낮으면 `prompt_bbox_update=HOLD`
     - `last_good_bbox/mask` 유지
  4) 오염 위험 플래그
     - `PROMPT_POISON_RISK` (score 낮은데 UPDATE 시도)
- **이유(묶어야 하는 이유)**
  - shape/연속성 없이 bbox sync나 soft penalty를 켜면 오염/풀마스크로 악화 가능
  - 이 Bundle이 있어야 “공격적 기능들”을 안전하게 시험 가능
- **기본값**: OFF (구현 완료 후 ON)

---

### B3. ROI Safety Brake Bundle (ROI 확장/탐색의 안전장치) — 기본 OFF(ROI 확장 실험 시 ON)
- **ID**: `BUNDLE_ROI_SAFETY_BRAKE`
- **포함 기능**
  1) `TOGGLE_SPEED_ROI_EXPANSION`의 브레이크:
     - UNCERTAIN/REACQUIRE에서는 확장 금지 또는 상한
     - `|pred - best_obs|` 큰 프레임에서는 확장 금지
  2) `ROI_EXPAND_DURING_UNCERTAIN` 플래그
  3) ROI cooldown/히스테리시스(펌핑 방지)
- **이유**
  - ROI 확장은 급이동에서 도움되지만, 불일치 프레임에서 치명적
  - 안전 브레이크 없이 단독 ON은 위험
- **기본값**: OFF (ROI 확장 실험 시에만 ON)

---

### B4. Dual Hypothesis Reacquire Bundle (2-가설 분기 재획득) — 기본 OFF(나중에)
- **ID**: `BUNDLE_DUAL_HYPOTHESIS_REACQUIRE`
- **포함 기능**
  1) 분기 트리거(급점프/급변/ID switch 의심)
  2) H1(Follow SAM2) vs H2(Follow Secondary)로 짧게(2~3프레임) 실행
  3) `final_score` 기반 승자 선택 + 연속 승리 시 ACTIVE 복귀
  4) 패자 가설 결과는 prompt_bbox/메모리에 반영 금지
- **전제**
  - B2(형태/연속성 기반 QA + prompt 보호)가 먼저 있어야 안전
- **기본값**: OFF

---

## 3) “단독 ON 금지” 관계(강제 규칙)
- `TOGGLE_SAM2_BBOX_SYNC`는 **BUNDLE_PROMPT_POISON_GUARD(B2)** 없으면 ON 금지
- `TOGGLE_SOFT_PRED_PENALTY`는 **B2** 없으면 ON 금지
- `TOGGLE_SPEED_ROI_EXPANSION`은 **BUNDLE_ROI_SAFETY_BRAKE(B3)** 없으면 ON 금지
- `BUNDLE_DUAL_HYPOTHESIS_REACQUIRE(B4)`는 **B2** 없으면 ON 금지

---

## 4) 추천 기본 프로파일(실험 시작점)
### Profile P0: Baseline 안정
- B1 ON
- T4 ON, T5 ON
- B2/B3/B4 OFF
- (오늘 악화된 기능들 모두 OFF)

### Profile P1: Prompt 오염 방지 + 형태 점수 테스트
- P0 + B2 ON
- 나머지 공격적 기능(ROI 확장/soft penalty/bbox sync) OFF

### Profile P2: ROI 확장 실험(안전 브레이크 포함)
- P1 + B3 ON + T3 ON
- 결과 지표: AREA_BLOWUP, BORDER_TOUCH_HIGH 증가 여부 확인

### Profile P3: Dual hypothesis 재획득 실험
- P1 + B4 ON
- 결과 지표: REACQUIRE 성공률, ID_SWITCH_SUSPECT 감소 여부 확인


# worm_detection develop 코드 점검 메모 (2026-02-04)

## 0) 결론 요약
현재 코드베이스는 **“AI가 결과를 보고( CSV/스냅샷 ) 스스로 악화/개선을 판단할 수 있게 만드는 디버깅 장치”** 방향으로는 꽤 잘 잡혀 있습니다.  
특히 `DebugLogger + ShapeStats + 자동 스냅샷 저장`은 다음 단계(에이전트/Claude/ChatGPT가 로그만 보고 리팩토링 실험)로 넘어가기 위한 최소조건을 충족합니다.

다만 **핵심 추적 안정성(“큰 이동 → bbox/ROI 엇갈림 → SAM2가 ROI 전체로 번짐”)**을 막기 위한 로직은 아직 **형태 정보를 ‘로그로만’ 쓰고** 있고, 지금 상태의 `Fusion/캐싱/area_check`에는 **실제로 SAM2 채택 자체를 막아버릴 수 있는 치명적인 순환 의존(Chicken-and-egg)** 이 들어가 있습니다.  
이 부분을 먼저 고쳐야 “디버그가 잘 찍히는데 성능은 계속 나쁜” 상태에서 벗어납니다.

---

## 1) 지금 코드에서 “의도대로 잘 된 부분”
### 1.1 토글 시스템 (A/B 테스트 기반)
- `config_toggles.py` + `config.yaml:toggles` 구조가 깔끔합니다.
- 위험 기능을 기본 OFF로 두고(ROI 확장, bbox sync 등), base 복구가 가능하게 한 건 맞는 방향입니다.
- `_warn_dependencies()`로 토글 의존성 경고까지 둔 것도 좋습니다.

### 1.2 디버깅 장치 (다음 목표에 직접 유효)
- `io_utils/debug_logger.py`
  - `debug_frames.jsonl`, `debug_frames.csv`, `events.md`, `run_summary.json` 생성
  - **이상징후 자동 플래그 + 스냅샷 저장**까지 들어가 있음  
- `qa/shape_analyzer.py`
  - 면적/둘레/solidity/aspect_ratio/두께(distance transform)/border_touch/shape_score/temporal_score 산출
  - “ROI 전체로 번짐(풀마스크)” 상황을 **border_touch, ROI 대비 면적비(area_ratio), thickness 폭증**으로 잡을 수 있는 토대가 이미 있음

> 즉, “사람이 영상을 일일이 보지 않아도” 문제 프레임을 자동으로 모아주는 장치는 이미 구현 방향이 맞습니다.

---

## 2) 실제 추적 성능을 망가뜨릴 수 있는 ‘치명적’ 문제점들

## 2.1 [치명] Fusion에서 SAM2 채택이 영구적으로 막힐 수 있는 구조
파일: `qa/fusion.py` (`_fuse_case_a_split` ACTIVE 모드)

현재 ACTIVE 모드 SAM2 채택 조건:
- `border_ok and shape_ok and has_consensus and area_check_available`

여기서 **`area_check_available`이 True가 되려면 `prev_area`가 있어야** 합니다.
그런데 `prev_area`는 runner에서 이렇게 가져옵니다:
- `prev_area = sam2_sensor._prev_areas.get(tr.id)` (단, `sam2_mask_caching` ON일 때)

그리고 `_prev_areas`는 언제 채워지냐:
- `sam2_sensor.cache_good_result(tr.id)`가 호출될 때만
- 그런데 이 호출 조건이 `fusion.sensor_used == "SAM2"` 임

즉, 지금 구조는 다음 순환이 됩니다:

1) ACTIVE에서 SAM2 채택하려면 prev_area 필요  
2) prev_area를 만들려면 "이전에 SAM2가 채택"되어야 함  
3) 하지만 채택이 안 되니 cache_good_result가 한 번도 안 불림  
4) 결과적으로 ACTIVE에서 SAM2 채택이 계속 막힐 수 있음 (특히 시작 구간)

이건 “코드가 의도와 다르게 동작할 수 있는” 수준이 아니라,
**조건에 따라 SAM2가 사실상 봉인되는 버그**입니다.

**권장 수정(방향만):**
- ACTIVE 모드에서 `area_check_available`을 “필수”가 아니라 “있으면 bonus, 없으면 penalty”로 바꾸는 게 안전합니다.
- 예: 첫 N프레임 또는 prev_area 없는 경우엔 `shape_ok=True`로 두고, 대신 quality에 작은 감점만.

---

## 2.2 [중요] runner의 bbox 동기화 로직에도 같은 순환 의존이 일부 존재
파일: `pipeline/runner.py` (`toggles.sam2_bbox_sync == True`일 때)

`smap2_bbox_ok` 판단에 `area_ok`가 들어가는데,
`area_ok`는 prev_area가 없으면 False로 떨어지게 되어 있습니다.

즉 bbox_sync 토글을 켠 순간,
- prev_area가 없어서 bbox 동기화가 안 됨
- bbox 동기화가 안 되면 SAM2 prompt box가 계속 엇갈릴 가능성 증가
- 엇갈리면 SAM2가 ROI 전체로 퍼질 확률 증가

지금 config에서 기본 OFF라 당장 치명은 아니지만,
**추후 토글 ON 테스트할 때 “왜 더 나빠지지?”를 유발하는 구조**입니다.

---

## 2.3 [중요] Shape(형태) 분석을 “로그로만” 쓰고, 결정 로직에는 거의 안 씀
현재 형태 기반 정보는:
- `ShapeStats` 계산 → `DebugLogger`에 기록 → 플래그 & 스냅샷용

하지만 핵심 목적(“SAM2가 풀마스크로 번지는 프레임을 reject/분기”)에는
**shape_score / border_touch / thickness / ROI 대비 면적비** 등이
**Fusion 채택/거부/분기 로직에 직접 반영되지 않습니다.**

지금 “근본 문제를 형태로 막겠다”는 방향이라면,
- **형태 점수(ShapeStats)를 Fusion의 QA에서 1차 게이트로 써야** 합니다.
- 특히 “큰 이동 직후 SAM2가 ROI 전체로 번짐”은
  - border_touch↑
  - ROI 대비 area_ratio↑
  - thickness_p90↑
  - solidity/shape_score 급락
  같은 신호가 강하게 뜰 가능성이 큽니다.

---

## 2.4 [중요] DebugLogger의 일부 플래그 조건이 실제 의미와 어긋날 수 있음
파일: `io_utils/debug_logger.py`

예:
- `CONSENSUS_BREAK` 조건이 `d_pred_sam2 > 50 and d_pred_tpl > 50` 같은 형태인데,
  - 이건 “합의 붕괴”가 아니라 “pred와 SAM2가 멀다 + pred와 tpl이 멀다”에 가깝습니다.
  - 실제 합의 붕괴는 `d_sam2_tpl`, `d_sam2_klt`, `d_tpl_klt` 같은 센서 상호 거리가 더 직관적입니다.
- `CENTER_JUMP` 고정 임계(100px)는 영상/ROI 스케일에 따라 무의미할 수 있음  
  - ROI diag 비율 기반으로 바꾸면 로그 품질이 올라갑니다.

이건 “추적 성능”을 직접 망가뜨리진 않지만,
**AI가 로그로 자동 판단할 때 오판을 유발**할 수 있어 다음 목표에 중요합니다.

---

## 2.5 ArtifactWriter의 `tracks.csv`에 ROI 좌표가 비어 있음
파일: `io_utils/artifacts.py`

- `_CSV_FIELDS`에는 roi_x0..roi_y1가 있으나 실제 write에서 빈값.
- 대신 `debug_frames.csv`에 ROI가 기록되니 당장 필수는 아니지만,
  “간단한 트랙 CSV만 보고도 판단”하려면 ROI를 채우는 게 낫습니다.

---

## 3) “AI가 스스로 개선/악화 점검”을 하게 만들기 위한 디버깅 장치 제안 (현 코드 기반 강화)

## 3.1 출력물 구성(권장 표준)
현재 출력물:
- overlay.mp4 (선택)
- tracks.csv
- events.jsonl
- debug_frames.jsonl / debug_frames.csv
- events.md
- run_summary.json
- snapshots/*.png (flag 프레임)

여기에 **AI가 자동 판독하기 좋은 최소 패키지**로 아래 2개를 추가하는 걸 권장합니다.

### (A) `debug_manifest.json`
- 어떤 파일이 어디에 있고, 어떤 토글로 실행됐는지, 영상 fps/배속/ROI base_size 등 실행 메타를 한 파일에 정리
- 목적: Claude/ChatGPT가 “폴더 구조를 추측하지 않고” 바로 파싱 가능

예 필드:
- input_path, fps, frame_count, roi.base/min/max, toggles, sensor enabled flags
- debug_files: {debug_csv, debug_jsonl, summary_json, events_md, snapshots_dir, overlay_video}

### (B) `top_anomalies.md`
- run_summary + debug_frames를 요약해서 “가장 문제 프레임 20개”를 한 장으로 제공
- 목적: 사람이 영상 없이도 빠르게 상황 파악, AI도 이 파일로 바로 탐색 시작 가능

포함 내용:
- 플래그별 상위 발생
- `AREA_BLOWUP_UP`, `BORDER_TOUCH_HIGH`, `LOW_SHAPE_SCORE`, `CENTER_JUMP` 등
  발생 프레임 Top-N (track_id 포함)
- 각 프레임에 해당하는 snapshot 파일명 링크(상대경로)

---

## 3.2 “형태 기반 판단”을 디버깅 가능하게 만드는 핵심 로그 항목
현재도 shape_stats를 기록하지만, 다음을 **추적 의사결정과 동일한 기준으로 기록**해야 합니다.

권장 추가 기록(각 프레임):
- `mask_roi_area_ratio = mask_area / (roi_w*roi_h)`
- `mask_bbox_area_ratio = mask_area / bbox_area` (bbox 대비 너무 꽉 차면 풀마스크 의심)
- `shape_mode`(ELONGATED/COILED/UNKNOWN) + `shape_score`
- `temporal_score`(전 프레임 대비 안정성)
- `border_touch`, `thickness_p90`, `aspect_ratio`, `solidity`

> 중요한 건 “지표는 많은데 실제 의사결정이 어떤 기준으로 이뤄졌는지 모르는 상태”를 피하는 겁니다.  
> 그래서 의사결정에 쓰는 지표는 반드시 debug_frames에도 동일 이름으로 남겨야 합니다.

---

## 4) 지금 코드가 “다음 목표(자동 리팩토링 실험)”로 가기 충분한가?
### 충분한 점
- 토글 시스템이 있어 “실험 단위”를 만들기 쉽다
- debug_frames.csv/jsonl로 **AI가 숫자 기반 평가**를 하기에 좋다
- snapshots 저장으로 **AI가 이미지 기반으로도 확인**할 수 있는 최소 고리가 있다

### 부족/위험한 점 (이 상태로 리팩토링 자동화 들어가면 반복적으로 시간 낭비 가능)
1) **Fusion에서 SAM2 채택이 막힐 수 있는 순환 의존** (2.1)  
   → 이걸 해결하지 않으면 “아무리 튜닝해도 성능이 오르지 않는” 상황이 생깁니다.
2) ShapeStats가 결정 로직에 거의 반영되지 않음  
   → 형태 기반 설계를 하려면 다음 단계에서 반드시 반영 필요
3) Debug 플래그 기준 일부가 센서 의미와 불일치  
   → AI가 로그로 판단할 때 잘못된 방향으로 수정 제안할 가능성

---

## 5) 다음 액션(코드 수정 ‘논의 전’에 체크할 우선순위)
우선순위 1개만 고르라면, 아래입니다.

### P0: “SAM2 채택 순환 의존” 제거
- ACTIVE 모드에서 `prev_area` 없으면 채택 불가 → 이 구조를 반드시 깨야 함
- 수정 방향(예시):
  - `area_check_available`이 False면:
    - 하드 게이트 해제
    - 대신 `adjusted_quality -= small_penalty`
    - 그리고 그 프레임 SAM2를 채택했다면 cache_good_result로 prev_area를 만들도록 유도

### P1: ShapeStats를 Fusion QA에 직접 사용(최소 게이트)
- border_touch/ROI면적비/thickness/shape_score로 “풀마스크”를 1차 차단
- 이때도 토글로 켜고 끄게 만들어야 A/B가 가능

### P2: DebugLogger 플래그를 ROI 스케일 기반으로 정규화
- 고정 px 임계(100px 등)를 ROI diag 비율로 변경
- “영상 배속/해상도 바뀌어도” 의미가 유지되게

---

## 6) 코드 구조/품질 관점에서의 짧은 코멘트
- `Sam2Sensor.initialize()`가 `pass`인 건 의도적으로 “이미지 predictor는 measure 때 set_image”라서 괜찮을 수 있습니다.  
  다만 “첫 프레임 시드 기반 prompt 힌트(점/마스크)”를 넣을 계획이면 initialize에서 트랙별 힌트 저장 구조를 두는 게 자연스럽습니다.
- `runner.py`의 frame_idx가 1부터 시작합니다. 큰 문제는 아니지만,
  외부 툴/평가에서 0-index 기준과 섞이면 혼동이 생길 수 있어 통일 권장입니다.
- `ArtifactWriter.write_frame()`에 ROI가 비어 있는 건 아쉽지만,
  debug_frames가 사실상 메인 평가 데이터가 될 거면 우선순위는 낮습니다.

---

## 7) 내가 보기엔 “의도대로 잘 작성된가?”에 대한 최종 판정
- **디버깅 인프라 방향은 맞고, 다음 목표(AI가 로그 보고 판단)로는 충분히 진입 가능**합니다.
- 하지만 지금 상태에서 추적 성능이 개선되지 않는 가장 큰 이유는,
  형태 기반 설계 이전에 **Fusion/캐싱의 순환 의존 버그 가능성이 매우 크고**,  
  형태 정보는 아직 “판단”이 아니라 “기록” 단계에 머물러 있기 때문입니다.

이 문서의 P0만 해결해도,
- SAM2가 실제로 채택되는 프레임이 생기고
- 캐싱이 돌기 시작하고
- 그때부터 shape 기반 게이트/분기 설계가 의미를 갖기 시작합니다.


# Claude 답변에 대한 내 의견 (2026-02-04)

## 0) 결론
Claude의 답변은 전반적으로 타당하며, 우선순위(P0~P4)도 현실적이다.  
내가 이전에 “SAM2 봉인”이라고 강하게 말한 부분은 **과장된 표현이었고**, Claude가 정리한 **복구 경로(UNCERTAIN → REACQUIRE → cache_good_result → ACTIVE 복귀)**는 실제로 존재한다.

다만 핵심은 “영구 봉인” 여부가 아니라:
- **초반 몇 프레임의 불필요한 상태 저하**가
- 급이동/저 FPS 환경에서 **오염(ROI/prompt) 루프의 시작점**이 될 수 있다는 점이다.

따라서 Claude가 제안한 **P0는 즉시 수정하는 게 맞다.**

---

## 1) 2.1 (순환 의존) 평가 — Claude 설명에 동의, 표현만 조정
- 맞는 지적: `area_check_available`이 `prev_area` 필요 → `prev_area`는 `SAM2 채택 + cache_good_result()` 이후 생김  
- 트랙이 ACTIVE로 시작하면 **초반 프레임에서 SAM2 채택이 하드게이트로 막혀** 불필요하게 상태 저하가 발생한다.
- 내가 “사실상 봉인”이라고 한 것은 일부 상황을 강조한 표현이고, Claude 말대로 복구 경로는 있다.

### 하지만 여전히 “실제 버그”인 이유
- 초반에 ACTIVE에서 SAM2가 막히면 UNCERTAIN/REACQUIRE로 내려가는데,
- 이 과정에서 ROI 확장/프롬프트 흔들림이 발생하면,
- **복구 경로가 오히려 잘못된 관측(배경/풀마스크)을 정상화하는 통로**가 될 수 있다.

따라서 “영구 봉인”이 아니어도 **초반 수 프레임의 불필요한 다운그레이드**는 제거해야 한다.

---

## 2) 2.2 (bbox sync 순환 의존) — 동의, 현재는 비활성이라 우선순위 낮음
- runner의 bbox sync도 prev_area 의존 구조가 맞다.
- 토글이 기본 OFF면 당장 영향은 적다.
- 다만 ON 테스트 전에 반드시 같이 수정해야 함(Claude의 P3 판단 동의).

---

## 3) 2.3 (ShapeStats 미반영) — 동의, 단계적 접근도 합리적
- 현재 shape_score/border_touch/thickness 등이 로그로만 기록되고 결정 로직에 직접 반영되지 않는다는 지적은 맞다.
- “먼저 로그 관찰 → 패턴 확인 후 게이트 통합”이라는 단계적 접근도 합리적이다.

### 단, 다음 단계(P2)에서의 주의점
- shape 게이트를 곧바로 “하드 reject(채택 금지)”로 시작하면
  - 또 다른 형태의 봉인/리콜 저하 문제가 생길 수 있다.
- 초기 통합은 아래처럼 “오염 방지 중심”의 소프트 제어가 안전하다:
  - prompt_bbox 업데이트 HOLD
  - quality 감점 + UNCERTAIN 힌트
  - REACQUIRE 트리거 강화
- 풀마스크 방지의 핵심은 “채택 자체 차단”보다 **prompt_bbox 오염 차단**인 경우가 많다.

---

## 4) 2.4 (Debug 플래그 기준) — ROI 정규화 필요, 동의
- 고정 px 임계값(CENTER_JUMP, THICKNESS_HIGH 등)은 스케일 의존이라 AI/사람 모두 해석이 흔들린다.
- ROI diag(또는 seed 크기) 비율로 정규화하는 게 맞다.
- CONSENSUS_BREAK는 pred-센서 거리보다 **센서 간 거리(d_sam2_tpl, d_sam2_klt 등)**가 더 적절하다(동의).

---

## 5) Bundle(묶음 토글) 관련 — “코드 강제”는 과할 수 있으나 “프로파일”은 필요
- Claude 주장: bundle은 과도한 추상화, flat toggle + 의존 경고면 충분
- 내 의견:
  - 코드에서 bundle을 강제할 필요는 없음(동의)
  - 하지만 실험 재현성을 위해 “추천 조합”을 **config preset 파일로 고정**하는 건 유의미함
    - 예: `configs/presets/P0_baseline.yaml`, `P1_shape_guard.yaml` 등

---

## 6) 우선순위에 대한 최종 동의/보완
### Claude 우선순위(P0~P4) — 거의 그대로 동의
- **P0**: ACTIVE 모드 area_check_available 하드게이트 제거 → 즉시 진행 권장
- **P1**: Debug 플래그 ROI 정규화 → 다음 목표(AI 로그 판독)에 직결
- **P2**: ShapeStats를 fusion QA 게이트로 통합 → 풀마스크 방지 핵심  
  - 단, “하드 reject”가 아니라 “오염 방지(HOLD) 중심”으로 단계 적용 권장
- **P3**: bbox sync 순환 제거 → bbox sync ON 테스트 전 선행
- **P4**: CONSENSUS_BREAK 기준 수정 → 로그 품질 개선(사실 P1과 묶어도 됨)

---

## 7) 결론(실행 제안)
- Claude가 말한 대로 **P0는 명확한 버그**이므로 바로 수정하는 게 맞다.
- P0 전/후는 같은 영상에서 `run_summary.json` 지표로 비교해 개선/악화를 숫자로 확인해야 한다.
