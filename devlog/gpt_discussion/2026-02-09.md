# 2026-02-09 GPT Discussion

## 현재 상태

### 구현 완료
- **MC1 Mask Cleanup Pipeline** (`qa/mask_cleanup.py`)
  - CCF (Connected Component Filtering): pred_center에 가장 가까운 컴포넌트만 유지
  - 조건부 Erosion: 컴포넌트가 1개(전부 연결)이면 erode→CCF→dilate로 얇은 연결 끊기
  - Expected Region AND: baseline 면적+종횡비 기반 타원으로 과도 확산 차단
  - 트리거: shape_score < 0.8
  - 파이프라인: SAM2 mask → ShapeStats 1차 → cleanup → ShapeStats 2차 → fusion

### MC1 테스트 결과 (수치)
| 설정 | ACTIVE | OCCLUDED | UNCERTAIN | RESEED |
|------|--------|----------|-----------|--------|
| Baseline (모두 기본) | 383 | 176 | 14 | 1 |
| MC1 단독 | 473 (+90) | 51 (-125) | 21 | 1 |
| P2 단독 (state_roi_expansion ON) | 526 (+143) | 96 | 3 | 1 |
| MC1 + P2 | **569 (+186)** | 99 | 26 | 1 |

### 17개 토글 전체 목록 (현재 기본값)
```
[ON ] F1  active_reacquire_split       ACTIVE/REACQUIRE 모드 분리
[OFF] F2  soft_pred_penalty            pred 거리 소프트 페널티
[ON ] F3  strict_consensus             엄격 consensus (None=불합의)
[OFF] F4  area_continuity_penalty      면적 연속성 감점
[ON ] F5  reacquire_active_recovery    REACQUIRE→ACTIVE 복귀
[OFF] P1  speed_roi_expansion          속도 기반 ROI 확장
[OFF] P2  state_roi_expansion          UNCERTAIN/OCCLUDED ROI 1.25x
[OFF] P3  expansion_cooldown           ROI 확장 쿨다운 5프레임
[OFF] P4  sam2_bbox_sync               SAM2 bbox 독립 동기화
[OFF] P5  reacquire_box_expansion      REACQUIRE 시 box prompt 확장
[ON ] S1  composite_mask_selection     복합 점수 마스크 선택
[ON ] S2  template_update_gating       TPL 업데이트 품질 게이팅
[ON ] S3  klt_divergence_reinit        KLT 발산 재초기화
[ON ] S4  sam2_mask_caching            SAM2 결과 캐싱
[ON ] SH1 shape_quality_gate           shape 기반 마스크 거부
[OFF] MC1 mask_cleanup                 번짐 감지 시 CCF+Expected Region
[ON ] K1  velocity_decay_on_predict    predict-only 속도 감쇠
[OFF] SM1 occluded_to_uncertain_recovery  OCCLUDED→UNCERTAIN 복귀
```

### 단일 토글 A/B 테스트 결과 (baseline ACTIVE=383 대비)
| Toggle | ACTIVE | OCCLUDED | RESEED | 판정 |
|--------|--------|----------|--------|------|
| SH1_OFF | 714 (+331) | 27 | 0 | **FAKE** — 배경 추적 |
| MC1_ON | **473 (+90)** | **51** | 1 | 좋음 (OCCLUDED 71% 감소) |
| P2_ON | 526 (+143) | 96 | 1 | 좋음 (육안 확인됨) |
| F3_OFF | 565 (+182) | 72 | 1 | 좋지만 교차검증 약화 위험 |
| F2_ON | 489 (+106) | 141 | 1 | 보통 |
| P4_ON | 452 (+69) | 295 | 0 | 보통 |
| S3_OFF | 424 (+41) | 136 | 1 | 미미 |
| P1_ON | 383 (±0) | 176 | 1 | 무효과 |
| S2_OFF | 383 (±0) | 176 | 1 | 무효과 |
| F1_OFF | 329 (-54) | 114 | 2 | 해로움 |
| F4_ON | 318 (-65) | 126 | 2 | 해로움 |
| S4_OFF | 274 (-109) | 77 | 2 | 해로움 |
| S1_OFF | 283 (-100) | 68 | 2 | 해로움 |
| F5_OFF | 265 (-118) | 56 | 2 | 해로움 |
| K1_OFF | 미완 | | | |
| SM1_ON | 미완 | | | |

### 합의된 다음 단계 (2026-02-07)
- P0: Mask Cleanup ✅ 완료
- P1: mask_input (last_good only, 오염 시 금지)
- P2: prompt 개선 (box shrink + multi-positive)

---

## 논의 주제

### 1. MC1 결과 분석 — UNCERTAIN 증가 현상

MC1 ON 시 OCCLUDED가 크게 줄었지만 UNCERTAIN이 소폭 증가함:
- Baseline: UNCERTAIN=14 → MC1: UNCERTAIN=21 → MC1+P2: UNCERTAIN=26

**가설**: cleanup으로 마스크를 살렸지만, 정리된 마스크의 quality가 완전하지 않아
fusion에서 SAM2 채택은 되지만 quality_score가 낮아 UNCERTAIN 판정.

**질문**: 이 UNCERTAIN 증가가 문제인가? 아니면 "OCCLUDED(완전 실패)보다 UNCERTAIN(불확실하지만 추적 중)"이 더 나은 상태이므로 허용 가능한가?

### 2. MC1 파라미터 튜닝 필요성

현재 하드코딩된 값들:
- **트리거 임계값**: shape_score < 0.8 (cleanup 시도 기준)
- **Erosion**: kernel 3x3, iterations=2
- **Expected Region**: baseline × 1.5 배율
- **과도 절삭 방지**: result_area < baseline × 0.2 이면 취소

**질문**: 이 파라미터들을 config.yaml에 노출해야 하나? 아니면 현재 고정값으로 충분한가?

### 3. 다음 우선순위 — 토글 조합 탐색 vs Phase 2 진행

**옵션 A**: 토글 조합 최적화 먼저
- MC1 + P2 + F3 조합
- MC1 + P2 + F2 조합
- K1, SM1 미완 테스트 완료
- 최적 조합 확정 → config.yaml 기본값 변경

**옵션 B**: Phase 2 (mask_input) 진행
- last_good mask logits를 SAM2 predict()에 전달
- 오염 방지 조건 구현
- 번짐 근본 원인 대응

**옵션 C**: MC1 자체를 먼저 개선
- cleanup이 실패하는 케이스 분석 (overlay 기반)
- 파라미터 튜닝
- 추가 cleanup 전략 (예: contour smoothing)

**질문**: 어떤 순서가 가장 효율적인가?

### 4. F3 (strict_consensus OFF)와 MC1 조합의 안전성

F3 OFF = TPL/KLT가 None이면 합의 통과 → SAM2 단독 채택 가능.
MC1이 있으면 번짐 마스크가 정리되어 SAM2 결과가 더 깨끗해짐.

**가설**: MC1 + F3_OFF 조합이면, F3 OFF의 "교차검증 약화" 위험이 MC1의 "마스크 정리"로 보완될 수 있음.
→ SAM2가 단독 채택되더라도, 번짐은 cleanup으로 걸러지니까.

**질문**: 이 논리가 맞는가? MC1이 F3 OFF의 안전장치가 될 수 있는가?

### 5. 장기적 관점 — 어떤 수준이면 "충분히 좋은" 추적인가?

현재 255프레임, 3트랙 기준:
- 이론적 최대 ACTIVE = 765 (3 × 255)
- 현재 최고 MC1+P2 = 569 (74.4%)
- NEEDS_RESEED = 1 (1개 트랙 실패)

**질문**:
- 목표 ACTIVE 비율은?
- NEEDS_RESEED = 0을 목표로 해야 하나?
- 다른 영상에서도 테스트해야 하는 시점은 언제인가?
