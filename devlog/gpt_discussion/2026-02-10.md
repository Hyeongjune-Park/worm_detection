# 2026-02-10 GPT Discussion

## 논의 주제

(논의 내용 작성 예정)

## GPT 의견

(GPT 응답 붙여넣기)

## 결론 및 액션 아이템

(정리 예정)

# 2026-02-09 결과 해석 및 다음 수정 제안 (Dynamic R 실패 / bbox 고정 / 오염 루프)

## A) 이번 regression의 핵심 원인 (정리)
1) runner.py에서 K1(velocity_decay_on_predict)는 do_kalman_update=False일 때만 발동.
2) Dynamic R은 do_kalman_update=True를 유지한 채 R만 키움 → 실질적으로 measurement는 거의 무시하지만 velocity 감쇠는 안 됨.
3) 이미 잘못된 vx/vy가 생긴 상태에서 R이 커지면 보정이 안 되고 “방향성 드리프트”가 지속됨.
4) MC1은 shape/quality 신호를 인위적으로 올려 Dynamic R의 보호(=R↑)를 해제하는 케이스가 생김.
   - cleanup은 “살리기”이지 “신뢰도 증가”가 아님 → KF용 신뢰도는 별도로 다뤄야 함.

---

## B) Dynamic R은 '연속 스케일링'이 아니라 '모드 스위치'로 바꾸는 게 맞음
### 권장 로직 (가장 저비용 + 즉효)
- fusion 결과에서 kf_quality(or adjusted_quality_for_kf)를 만들고,
- 아래처럼 update/predict-only를 스위칭:

예시:
- kf_quality >= 0.75: update (R=base)
- 0.60 <= kf_quality < 0.75: update (R=base*scale) + **velocity decay(0.7)**
- kf_quality < 0.60 또는 r_scale>=3.0: **predict-only** (do_kalman_update=False) → 기존 K1로 decay(0.5)

runner.py 적용 포인트:
- do_kalman_update=True라도 measurement_r이 큰 경우 velocity도 감쇠시키는 보정 추가:
  - if fusion.measurement_r >= base_r*2: tr.kf.decay_velocity(0.7)
  - if fusion.measurement_r >= base_r*3: tr.kf.decay_velocity(0.5)

---

## C) "bbox 불일치"의 진짜 원인: SAM2 prompt 박스는 tr.bbox가 아니라 seed_bbox_size 고정 사용
- sensors/sam2_sensor.py에서 box prompt 크기는 track.seed_bbox_size 기반.
- runner의 P4(sam2_bbox_sync)는 tr.bbox만 갱신 → prompt 크기에는 영향 없음.
=> seed_bbox 고정 설계를 바꿔야 이 문제가 해결됨.

### 해결: adaptive prompt box size (EMA + gate + clamp)
- Track에 prompt_bbox_size(w,h) 추가 (초기=seed_bbox_size)
- '좋은 SAM2 마스크'일 때만 갱신:
  - 조건 예: border_ok && area_ratio_ok && (shape_score>=0.75) && has_consensus(optional)
- EMA:
  - w = (1-a)*w + a*mask_bbox_w
  - h = (1-a)*h + a*mask_bbox_h
  - a=0.2 정도
- clamp:
  - w,h는 seed 대비 [0.7x, 1.8x] 범위로 제한 (폭주 방지)
- 회전 대응:
  - UNCERTAIN/OCCLUDED에서만 square_box 옵션:
    - side = max(w,h)로 정사각형 prompt box 사용 (부분 누락 방지)

---

## D) MC1과 Dynamic R 상호작용 차단
- MC1이 적용된 프레임은 “살아있어도 불완전” 확률이 높음.
- 따라서 KF 신뢰도 계산에서 cleanup 패널티를 강제:
  - if mc1_applied: kf_quality = min(kf_quality, 0.70) 또는 effective_r = max(effective_r, base_r*2)
- 핵심: state_quality(상태머신/템플 업데이트용)와 kf_quality(R/업데이트 결정용)를 분리 권장.

---

## E) 방향성 점프(튐) 방지: innovation(outlier) gating 추가 권장
- SAM2가 다른 대상을 잡는 순간을 막는 정석 안전장치.
- 구현:
  - y = z - Hx, S = HPH^T + R, maha = y^T S^-1 y
  - maha > threshold(예: 9.21 @ 2 dof 99%)면 update reject → predict-only + velocity decay
- 효과: “새 대상 포착 → KF update → prompt 오염” 양성피드백 루프를 끊음.

---

## F) 다음 우선순위
1) adaptive prompt box size (seed_bbox 고정 제거)  ← 구조적 결함
2) Dynamic R 재설계: 모드 스위치 + high-R velocity decay + outlier gating
3) Phase2 mask_input(last_good logits / multi-positive) 진행
