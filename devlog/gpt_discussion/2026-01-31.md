# GPT 논의 - 2026-01-31

## 논의 주제: SAM2 마스크 정확 → QA 거부 문제

### 관찰된 현상

1. SAM2가 벌레의 큰 움직임을 정확히 추적 (마스크가 벌레 위치에 정확히 위치)
2. 그러나 bbox는 이전 위치에 머무르고 OCCLUDED 상태로 전환
3. Kalman 예측은 이동 방향을 잘 예측하지만 SAM2 결과가 반영되지 않음
4. 결과적으로 배경을 추적하기 시작

### 확인된 원인

**QA fusion의 `pred_ok` 하드 게이트** (`qa/fusion.py:111`)

```python
pred_ok = (d_pred <= dist_pred_th)  # dist_pred_th ≈ 65px
```

벌레가 65px 이상 움직이면:
1. SAM2가 정확한 위치를 찾아도
2. Kalman 예측과의 거리가 임계값 초과
3. `pred_ok = False` → SAM2 거부
4. Kalman 업데이트 안됨 → 악순환

---

## 해결 방안 후보

### 1. 임계값 완화
- `dist_pred_ratio`를 0.12 → 0.25 등으로 증가
- 장점: 간단
- 단점: 잘못된 SAM2도 수락할 수 있음

### 2. 속도 적응형 임계값
- Kalman 속도가 빠르면 임계값을 동적으로 증가
- 예: `dist_pred_th = base_th × (1 + speed_factor)`
- 장점: 빠른 움직임에 적응
- 단점: 속도 추정이 틀리면 문제

### 3. 방향 일관성 검사
- SAM2 center가 Kalman 속도 방향에 있으면 더 먼 거리 허용
- 예: SAM2가 예측 방향으로 멀어지면 OK, 반대 방향이면 거부
- 장점: 물리적으로 타당
- 단점: 급격한 방향 전환 시 문제

### 4. SAM2 신뢰도 기반 override
- SAM2 confidence가 매우 높으면 (>0.95) pred_ok 무시
- 장점: SAM2가 확신할 때 수락
- 단점: confidence가 항상 신뢰할 수 있는 건 아님

### 5. 거리 페널티 (하드 게이트 → 소프트 페널티)
- `pred_ok`를 boolean이 아닌 점수로 변환
- 거리가 멀수록 quality 감점, 하지만 완전 거부는 안 함
- 장점: 유연함
- 단점: 잘못된 SAM2가 낮은 quality로 수락될 수 있음

### 6. TPL/KLT 동의 시 override
- SAM2와 TPL/KLT가 동의하면 (둘 다 비슷한 위치) pred와 멀어도 수락
- 이미지 2에서 파란 네모(Kalman)가 벌레 방향을 가장 잘 추적했다는 관찰과 일치
- 장점: 교차검증 강화
- 단점: TPL/KLT도 틀릴 수 있음

---

## 권장 접근법

**단기**: 속도 적응형 임계값 (방안 2)
- 빠르게 구현 가능
- 기존 로직 유지하면서 개선

**중기**: 소프트 페널티 (방안 5) + 방향 일관성 (방안 3)
- 하드 게이트를 점수 기반으로 전환
- 물리적 타당성 추가

---

## 논의 필요 사항

1. 어떤 방안을 먼저 시도할지?
2. 임계값 튜닝 vs 로직 변경?
